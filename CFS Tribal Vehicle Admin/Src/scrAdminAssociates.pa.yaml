# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
#
# CFS Tribal Vehicle Admin — Associate / User Management
# Desktop layout: 1366x768 with 220px sidebar
# Features: Table of associates with reservation/checkout counts, add/edit panel,
#           view associate activity (recent reservations, checkouts, fuel)
# ************************************************************************************************
Screens:
  scrAdminAssociates:
    Properties:
      Fill: =varTheme.Background
      LoadingSpinnerColor: =RGBA(0, 120, 212, 1)
      OnVisible: |-
        =Set(varAdminSection, "Associates");
        Set(varAdminSearchText, "");
        Set(varShowEditPanel, false);
        Set(varShowAddAssociate, false);
        Set(varEditAssociate, Blank());
        Set(varIsSubmitting, false);
    Children:
      # ── LEFT SIDEBAR NAV ──
      - cmpAdminNav_Assoc:
          Control: CanvasComponent
          ComponentName: cmpAdminNav
          Properties:
            ActiveKey: ="Associates"
            Height: =Parent.Height
            Width: =220

      # ── MAIN CONTENT AREA ──
      - cnrAssocMain:
          Control: GroupContainer@1.4.0
          Variant: AutoLayout
          Properties:
            Fill: =varTheme.Background
            Height: =Parent.Height
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =0
            Width: =If(varShowEditPanel, Parent.Width - 220 - 420, Parent.Width - 220)
            X: =220
          Children:
            # ── PAGE HEADER ──
            - cnrAssocHeader:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  FillPortions: =0
                  Height: =60
                  Width: =Parent.Width
                Children:
                  - lblAssocTitle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =32
                        Size: =22
                        Text: ="Associate Management"
                        Width: =400
                        X: =24
                        Y: =14
                  - lblAssocCount:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =24
                        Size: =12
                        Text: =CountRows(Associates) & " associates"
                        Width: =200
                        X: =320
                        Y: =20
                  - recAssocHeaderBorder:
                      Control: Rectangle@2.3.0
                      Properties:
                        Fill: =varTheme.Border
                        Height: =1
                        Width: =Parent.Width
                        Y: =59

            # ── FILTER BAR ──
            - cnrAssocFilters:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  FillPortions: =0
                  Height: =56
                  Width: =Parent.Width
                Children:
                  - txtAssocSearch:
                      Control: TextInput@0.0.54
                      Properties:
                        Height: =32
                        OnChange: =Set(varAdminSearchText, Self.Value)
                        Placeholder: ="Search associates..."
                        Width: =280
                        X: =24
                        Y: =12
                  - btnAddAssociate:
                      Control: Button@0.0.45
                      Properties:
                        BasePaletteColor: =varTheme.Primary
                        Height: =32
                        OnSelect: |-
                          =Set(varEditAssociate, Blank());
                          Set(varShowAddAssociate, true);
                          Set(varShowEditPanel, true);
                        Text: ="+ Add Associate"
                        Width: =140
                        X: =Parent.Width - 164
                        Y: =12

            # ── ASSOCIATES TABLE ──
            - cnrAssocTableCard:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  RadiusBottomLeft: =8
                  RadiusBottomRight: =8
                  RadiusTopLeft: =8
                  RadiusTopRight: =8
                  Width: =Parent.Width
                Children:
                  # Column Headers
                  - lblAHdrName:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="NAME"
                        Width: =180
                        X: =16
                  - lblAHdrLocation:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="LOCATION"
                        Width: =130
                        X: =200
                  - lblAHdrEmail:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="EMAIL"
                        Width: =220
                        X: =334
                  - lblAHdrReservations:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="RESERVATIONS"
                        Width: =100
                        X: =558
                  - lblAHdrCheckouts:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="CHECKOUTS"
                        Width: =90
                        X: =662
                  - lblAHdrActions:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="ACTIONS"
                        Width: =160
                        X: =756
                  - recAssocTableHeaderLine:
                      Control: Rectangle@2.3.0
                      Properties:
                        Fill: =varTheme.Border
                        Height: =1
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =36
                  # Data Gallery
                  - galAssocTable:
                      Control: Gallery@2.15.0
                      Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
                      Properties:
                        BorderColor: =Color.Transparent
                        Height: =Parent.Height - 40
                        Items: |-
                          =SortByColumns(
                              Filter(
                                  Associates,
                                  IsBlank(varAdminSearchText) || varAdminSearchText = "" ||
                                  varAdminSearchText in Associate ||
                                  varAdminSearchText in Email ||
                                  varAdminSearchText in Location
                              ),
                              "cr63e_associate",
                              SortOrder.Ascending
                          )
                        LoadingSpinner: =LoadingSpinner.Controls
                        TemplatePadding: =0
                        TemplateSize: =44
                        Width: =Parent.Width
                        Y: =38
                      Children:
                        - cnrAssocRow:
                            Control: GroupContainer@1.4.0
                            Variant: ManualLayout
                            Properties:
                              Fill: =If(ThisItem.Associates = varEditAssociate.Associates, varTheme.PrimaryLight, Color.Transparent)
                              Height: =Parent.TemplateHeight
                              Width: =Parent.TemplateWidth
                            Children:
                              - lblARowName:
                                  Control: Label@2.5.1
                                  Properties:
                                    Color: =varTheme.TextPrimary
                                    FontWeight: =FontWeight.Semibold
                                    Height: =Parent.Height
                                    Size: =12
                                    Text: =ThisItem.Associate
                                    Width: =180
                                    X: =16
                              - lblARowLocation:
                                  Control: Label@2.5.1
                                  Properties:
                                    Color: =varTheme.TextPrimary
                                    Height: =Parent.Height
                                    Size: =12
                                    Text: =ThisItem.Location
                                    Width: =130
                                    X: =200
                              - lblARowEmail:
                                  Control: Label@2.5.1
                                  Properties:
                                    Color: =varTheme.TextSecondary
                                    Height: =Parent.Height
                                    Size: =11
                                    Text: =ThisItem.Email
                                    Width: =220
                                    X: =334
                              - lblARowResCount:
                                  Control: Label@2.5.1
                                  Properties:
                                    Align: =Align.Center
                                    Color: =varTheme.TextPrimary
                                    FontWeight: =FontWeight.Semibold
                                    Height: =Parent.Height
                                    Size: =12
                                    Text: =CountRows(Filter('Vehicle Reservations', Associate.Associates = ThisItem.Associates))
                                    Width: =100
                                    X: =558
                              - lblARowCOCount:
                                  Control: Label@2.5.1
                                  Properties:
                                    Align: =Align.Center
                                    Color: =varTheme.TextPrimary
                                    FontWeight: =FontWeight.Semibold
                                    Height: =Parent.Height
                                    Size: =12
                                    Text: =CountRows(Filter('Vehicle Checkouts', Associate.Associates = ThisItem.Associates))
                                    Width: =90
                                    X: =662
                              - btnARowEdit:
                                  Control: Button@0.0.45
                                  Properties:
                                    Appearance: ="Transparent"
                                    FontColor: =varTheme.Primary
                                    Height: =30
                                    OnSelect: |-
                                      =Set(varEditAssociate, ThisItem);
                                      Set(varShowAddAssociate, false);
                                      Set(varShowEditPanel, true);
                                    Text: ="Edit"
                                    Width: =50
                                    X: =756
                                    Y: =7
                              - btnARowActivity:
                                  Control: Button@0.0.45
                                  Properties:
                                    Appearance: ="Transparent"
                                    FontColor: =varTheme.TextSecondary
                                    Height: =30
                                    OnSelect: |-
                                      =Set(varEditAssociate, ThisItem);
                                      Set(varShowAddAssociate, false);
                                      Set(varShowEditPanel, true);
                                    Text: ="Activity"
                                    Width: =64
                                    X: =810
                                    Y: =7
                              - recARowDivider:
                                  Control: Rectangle@2.3.0
                                  Properties:
                                    Fill: =varTheme.Border
                                    Height: =1
                                    Width: =Parent.Width - 32
                                    X: =16
                                    Y: =Parent.Height - 1

      # ── EDIT / ADD / ACTIVITY PANEL (right side, 420px) ──
      - cnrAssocPanel:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =varTheme.Surface
            Height: =Parent.Height
            Visible: =varShowEditPanel
            Width: =420
            X: =Parent.Width - 420
          Children:
            - recAssocPanelShadow:
                Control: Rectangle@2.3.0
                Properties:
                  Fill: =RGBA(0, 0, 0, 0.08)
                  Height: =Parent.Height
                  Width: =2
            - lblAssocPanelTitle:
                Control: Label@2.5.1
                Properties:
                  Color: =varTheme.TextPrimary
                  FontWeight: =FontWeight.Bold
                  Height: =40
                  Size: =18
                  Text: =If(varShowAddAssociate, "Add Associate", If(!IsBlank(varEditAssociate), varEditAssociate.Associate, "Edit Associate"))
                  Width: =320
                  X: =20
                  Y: =16
            - btnAssocClosePanel:
                Control: Button@0.0.45
                Properties:
                  Appearance: ="Transparent"
                  FontColor: =varTheme.TextSecondary
                  Height: =36
                  OnSelect: |-
                    =Set(varShowEditPanel, false);
                    Set(varEditAssociate, Blank());
                    Set(varShowAddAssociate, false);
                  Text: ="X"
                  Width: =40
                  X: =Parent.Width - 56
                  Y: =16
            - recAssocPanelDivider:
                Control: Rectangle@2.3.0
                Properties:
                  Fill: =varTheme.Border
                  Height: =1
                  Width: =Parent.Width - 32
                  X: =16
                  Y: =60

            # ── EDIT FORM FIELDS ──
            - lblAFName:
                Control: Label@2.5.1
                Properties:
                  Color: =varTheme.TextPrimary
                  FontWeight: =FontWeight.Semibold
                  Height: =20
                  Size: =12
                  Text: ="Associate Name *"
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =72
            - txtAFName:
                Control: TextInput@0.0.54
                Properties:
                  Default: =If(!varShowAddAssociate && !IsBlank(varEditAssociate), varEditAssociate.Associate, "")
                  Height: =32
                  Placeholder: ="Full name..."
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =94
            - lblAFLocation:
                Control: Label@2.5.1
                Properties:
                  Color: =varTheme.TextPrimary
                  FontWeight: =FontWeight.Semibold
                  Height: =20
                  Size: =12
                  Text: ="Location *"
                  Width: =170
                  X: =20
                  Y: =138
            - txtAFLocation:
                Control: TextInput@0.0.54
                Properties:
                  Default: =If(!varShowAddAssociate && !IsBlank(varEditAssociate), varEditAssociate.Location, "")
                  Height: =32
                  Placeholder: ="Location..."
                  Width: =170
                  X: =20
                  Y: =160
            - lblAFEmail:
                Control: Label@2.5.1
                Properties:
                  Color: =varTheme.TextPrimary
                  FontWeight: =FontWeight.Semibold
                  Height: =20
                  Size: =12
                  Text: ="Email *"
                  Width: =190
                  X: =210
                  Y: =138
            - txtAFEmail:
                Control: TextInput@0.0.54
                Properties:
                  Default: =If(!varShowAddAssociate && !IsBlank(varEditAssociate), varEditAssociate.Email, "")
                  Height: =32
                  Placeholder: ="email@example.com"
                  Width: =190
                  X: =210
                  Y: =160
            # Action Buttons
            - btnAFSave:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =varTheme.Primary
                  DisplayMode: |-
                    =If(
                        IsBlank(txtAFName.Value) || txtAFName.Value = "" ||
                        IsBlank(txtAFLocation.Value) || txtAFLocation.Value = "" ||
                        IsBlank(txtAFEmail.Value) || txtAFEmail.Value = "",
                        DisplayMode.Disabled,
                        DisplayMode.Edit
                    )
                  Height: =36
                  OnSelect: |-
                    =Set(varIsSubmitting, true);

                    If(
                        varShowAddAssociate,
                        Set(
                            varPatchResult,
                            Patch(
                                Associates,
                                Defaults(Associates),
                                {
                                    Associate: txtAFName.Value,
                                    Location: txtAFLocation.Value,
                                    Email: txtAFEmail.Value
                                }
                            )
                        ),
                        Set(
                            varPatchResult,
                            Patch(
                                Associates,
                                varEditAssociate,
                                {
                                    Associate: txtAFName.Value,
                                    Location: txtAFLocation.Value,
                                    Email: txtAFEmail.Value
                                }
                            )
                        )
                    );

                    If(
                        IsError(varPatchResult),
                        Notify("Failed to save associate.", NotificationType.Error),
                        Notify(
                            If(varShowAddAssociate, "Associate added!", "Associate updated!"),
                            NotificationType.Success
                        );
                        Set(varShowEditPanel, false);
                        Set(varEditAssociate, Blank());
                        Set(varShowAddAssociate, false)
                    );

                    Set(varIsSubmitting, false);
                  Text: =If(varShowAddAssociate, "Add Associate", "Save Changes")
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =210
            - btnAFCancel:
                Control: Button@0.0.45
                Properties:
                  Appearance: ="Secondary"
                  Height: =36
                  OnSelect: |-
                    =Set(varShowEditPanel, false);
                    Set(varEditAssociate, Blank());
                    Set(varShowAddAssociate, false);
                  Text: ="Cancel"
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =254

            # ── ACTIVITY SECTION (shown when editing an existing associate) ──
            - recActivityDivider:
                Control: Rectangle@2.3.0
                Properties:
                  Fill: =varTheme.Border
                  Height: =1
                  Visible: =!varShowAddAssociate && !IsBlank(varEditAssociate)
                  Width: =Parent.Width - 32
                  X: =16
                  Y: =304
            - lblActivityTitle:
                Control: Label@2.5.1
                Properties:
                  Color: =varTheme.TextPrimary
                  FontWeight: =FontWeight.Semibold
                  Height: =28
                  Size: =14
                  Text: ="Recent Activity"
                  Visible: =!varShowAddAssociate && !IsBlank(varEditAssociate)
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =314

            # Recent Reservations
            - lblActivityRes:
                Control: Label@2.5.1
                Properties:
                  Color: =varTheme.TextSecondary
                  FontWeight: =FontWeight.Semibold
                  Height: =22
                  Size: =11
                  Text: ="RECENT RESERVATIONS"
                  Visible: =!varShowAddAssociate && !IsBlank(varEditAssociate)
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =344
            - galActivityRes:
                Control: Gallery@2.15.0
                Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
                Properties:
                  BorderColor: =Color.Transparent
                  Height: =120
                  Items: |-
                    =If(
                        !IsBlank(varEditAssociate),
                        FirstN(
                            Sort(
                                Filter('Vehicle Reservations', Associate.Associates = varEditAssociate.Associates),
                                StartDateTime,
                                SortOrder.Descending
                            ),
                            3
                        )
                    )
                  LoadingSpinner: =LoadingSpinner.Controls
                  TemplatePadding: =0
                  TemplateSize: =36
                  Visible: =!varShowAddAssociate && !IsBlank(varEditAssociate)
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =366
                Children:
                  - cnrActResRow:
                      Control: GroupContainer@1.4.0
                      Variant: ManualLayout
                      Properties:
                        Fill: =Color.Transparent
                        Height: =Parent.TemplateHeight
                        Width: =Parent.TemplateWidth
                      Children:
                        - lblActResVehicle:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextPrimary
                              Height: =Parent.Height
                              Size: =11
                              Text: =ThisItem.Vehicle.'Vehicle Name'
                              Width: =140
                        - lblActResDate:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =11
                              Text: =Text(ThisItem.StartDateTime, "mmm d") & " - " & Text(ThisItem.EndDateTime, "mmm d")
                              Width: =130
                              X: =144
                        - lblActResStatus:
                            Control: Label@2.5.1
                            Properties:
                              Align: =Align.Right
                              Color: |-
                                =Switch(
                                    ThisItem.'Status (cr63e_status)',
                                    'Status (Vehicle Reservations)'.Approved, varStatusColors.Approved,
                                    'Status (Vehicle Reservations)'.Cancelled, varStatusColors.Cancelled,
                                    'Status (Vehicle Reservations)'.Returned, varStatusColors.Returned,
                                    varTheme.TextSecondary
                                )
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =10
                              Text: =Text(ThisItem.'Status (cr63e_status)')
                              Width: =80
                              X: =Parent.Width - 80

            # Recent Checkouts
            - lblActivityCO:
                Control: Label@2.5.1
                Properties:
                  Color: =varTheme.TextSecondary
                  FontWeight: =FontWeight.Semibold
                  Height: =22
                  Size: =11
                  Text: ="RECENT CHECKOUTS"
                  Visible: =!varShowAddAssociate && !IsBlank(varEditAssociate)
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =492
            - galActivityCO:
                Control: Gallery@2.15.0
                Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
                Properties:
                  BorderColor: =Color.Transparent
                  Height: =100
                  Items: |-
                    =If(
                        !IsBlank(varEditAssociate),
                        FirstN(
                            Sort(
                                Filter('Vehicle Checkouts', Associate.Associates = varEditAssociate.Associates),
                                CheckedOutAt,
                                SortOrder.Descending
                            ),
                            3
                        )
                    )
                  LoadingSpinner: =LoadingSpinner.Controls
                  TemplatePadding: =0
                  TemplateSize: =32
                  Visible: =!varShowAddAssociate && !IsBlank(varEditAssociate)
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =514
                Children:
                  - cnrActCORow:
                      Control: GroupContainer@1.4.0
                      Variant: ManualLayout
                      Properties:
                        Fill: =Color.Transparent
                        Height: =Parent.TemplateHeight
                        Width: =Parent.TemplateWidth
                      Children:
                        - lblActCOVehicle:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextPrimary
                              Height: =Parent.Height
                              Size: =11
                              Text: =ThisItem.Vehicle.'Vehicle Name'
                              Width: =140
                        - lblActCODate:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =11
                              Text: =Text(ThisItem.CheckedOutAt, "mmm d h:mm AM/PM")
                              Width: =160
                              X: =144
                        - lblActCOReturn:
                            Control: Label@2.5.1
                            Properties:
                              Align: =Align.Right
                              Color: =If(IsBlank(ThisItem.ReturnedAt), varStatusColors.CheckedOut, varStatusColors.Available)
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =10
                              Text: =If(IsBlank(ThisItem.ReturnedAt), "OUT", "Returned")
                              Width: =60
                              X: =Parent.Width - 60

            # Recent Fuel Purchases
            - lblActivityFuel:
                Control: Label@2.5.1
                Properties:
                  Color: =varTheme.TextSecondary
                  FontWeight: =FontWeight.Semibold
                  Height: =22
                  Size: =11
                  Text: ="RECENT FUEL PURCHASES"
                  Visible: =!varShowAddAssociate && !IsBlank(varEditAssociate)
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =620
            - galActivityFuel:
                Control: Gallery@2.15.0
                Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
                Properties:
                  BorderColor: =Color.Transparent
                  Height: =100
                  Items: |-
                    =If(
                        !IsBlank(varEditAssociate),
                        FirstN(
                            Sort(
                                Filter('Fuel Transactions', SubmittedBy.Associates = varEditAssociate.Associates),
                                TransactionDateTime,
                                SortOrder.Descending
                            ),
                            3
                        )
                    )
                  LoadingSpinner: =LoadingSpinner.Controls
                  TemplatePadding: =0
                  TemplateSize: =32
                  Visible: =!varShowAddAssociate && !IsBlank(varEditAssociate)
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =642
                Children:
                  - cnrActFuelRow:
                      Control: GroupContainer@1.4.0
                      Variant: ManualLayout
                      Properties:
                        Fill: =Color.Transparent
                        Height: =Parent.TemplateHeight
                        Width: =Parent.TemplateWidth
                      Children:
                        - lblActFuelVehicle:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextPrimary
                              Height: =Parent.Height
                              Size: =11
                              Text: =ThisItem.Vehicle.'Vehicle Name'
                              Width: =140
                        - lblActFuelDate:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =11
                              Text: =Text(ThisItem.TransactionDateTime, "mmm d, yyyy")
                              Width: =120
                              X: =144
                        - lblActFuelAmount:
                            Control: Label@2.5.1
                            Properties:
                              Align: =Align.Right
                              Color: =varTheme.TextPrimary
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =11
                              Text: ="$" & Text(ThisItem.Amount, "#,##0.00")
                              Width: =80
                              X: =Parent.Width - 80
