# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  scrAdminMaintenance:
    Properties:
      Fill: =varTheme.Background
      LoadingSpinnerColor: =varTheme.Primary
      OnVisible: |-
        =Set(varActiveScreen, "Maintenance");
        Set(varMaintFilterStatus, "All");
        Set(varMaintFilterVehicle, Blank());
        Set(varSelectedMaintenance, Blank());

        ClearCollect(
            colAdminMaintenance,
            Sort(
                'Vehicle Maintenances',
                ReportedDateTime,
                SortOrder.Descending
            )
        );
    Children:
      - cmpAdminNav_Maintenance:
          Control: CanvasComponent
          ComponentName: cmpAdminNav
          Properties:
            ActiveScreen: ="Maintenance"
            Height: =Parent.Height
            Width: =220
      - cnrMaintContent:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =varTheme.Background
            Height: =Parent.Height
            PaddingBottom: =0
            PaddingLeft: =0
            Width: =Parent.Width - 220
            X: =220
          Children:
            - cnrMaintHeader:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  Height: =64
                  PaddingBottom: =0
                  PaddingLeft: =0
                  Width: =Parent.Width
                Children:
                  - lblMaintTitle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =40
                        PaddingLeft: =8
                        Size: =20
                        Text: ="Maintenance Management"
                        Width: =400
                        X: =24
                        Y: =12
                  - lblMaintSubtitle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =20
                        Size: =12
                        Text: |-
                          =CountRows(
                              Filter(
                                  colAdminMaintenance,
                                  'Status (cr63e_status)' = 'Status (Vehicle Maintenances)'.Open ||
                                  'Status (cr63e_status)' = 'Status (Vehicle Maintenances)'.'In Progress'
                              )
                          ) & " open items"
                        Width: =300
                        X: =24
                        Y: =40
            - cnrMaintFilters:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  Height: =52
                  PaddingBottom: =0
                  PaddingLeft: =0
                  Width: =Parent.Width
                  Y: =64
                Children:
                  - ddMaintStatusFilter:
                      Control: DropDown@0.0.45
                      Properties:
                        Height: =36
                        Items: =["All", "Open", "In Progress", "Closed"]
                        OnChange: =Set(varMaintFilterStatus, Self.Selected.Value)
                        Width: =160
                        X: =24
                        Y: =8
                  - ddMaintVehicleFilter:
                      Control: DropDown@0.0.45
                      Properties:
                        Height: =36
                        Items: =Ungroup(Table({Value: "All Vehicles"}, ForAll(Sort(CFSVehicles, 'Vehicle Name'), {Value: 'Vehicle Name'})), "Value")
                        OnChange: |-
                          =If(
                              Self.Selected.Value = "All Vehicles",
                              Set(varMaintFilterVehicle, Blank()),
                              Set(varMaintFilterVehicle, Self.Selected.Value)
                          )
                        Width: =200
                        X: =200
                        Y: =8
            - cnrMaintTableHeader:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Background
                  Height: =36
                  PaddingBottom: =0
                  PaddingLeft: =0
                  Width: =Parent.Width
                  Y: =116
                Children:
                  - lblMaintColVehicle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Vehicle"
                        Width: =140
                        X: =24
                  - lblMaintColType:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Type"
                        Width: =140
                        X: =164
                  - lblMaintColDesc:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Description"
                        Width: =180
                        X: =304
                  - lblMaintColStatus:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Status"
                        Width: =90
                        X: =484
                  - lblMaintColOOS:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Out of Service"
                        Width: =100
                        X: =574
                  - lblMaintColReported:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Reported By"
                        Width: =110
                        X: =674
                  - lblMaintColDate:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Date"
                        Width: =90
                        X: =784
                  - lblMaintColActions:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Actions"
                        Width: =100
                        X: =Parent.Width - 124
            - galMaintTable:
                Control: Gallery@2.15.0
                Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
                Properties:
                  BorderColor: =varTheme.Border
                  Height: =Parent.Height - 152
                  Items: |-
                    =Sort(
                        Filter(
                            colAdminMaintenance,
                            (varMaintFilterStatus = "All" || Text('Status (cr63e_status)') = varMaintFilterStatus) &&
                            (IsBlank(varMaintFilterVehicle) || ThisItem.Vehicle.'Vehicle Name' = varMaintFilterVehicle)
                        ),
                        ReportedDateTime,
                        SortOrder.Descending
                    )
                  LoadingSpinner: =LoadingSpinner.Controls
                  TemplatePadding: =1
                  TemplateSize: =50
                  Width: =Parent.Width
                  Y: =152
                Children:
                  - cnrMaintTableRow:
                      Control: GroupContainer@1.4.0
                      Variant: ManualLayout
                      Properties:
                        Fill: =varTheme.Surface
                        Height: =Parent.TemplateHeight - 2
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Width: =Parent.TemplateWidth
                      Children:
                        - recMaintRowAccent:
                            Control: Rectangle@2.3.0
                            Properties:
                              Fill: |-
                                =If(
                                    ThisItem.OutOfService,
                                    varStatusColors.OutOfService,
                                    Switch(
                                        ThisItem.'Status (cr63e_status)',
                                        'Status (Vehicle Maintenances)'.Open, varStatusColors.Warning,
                                        'Status (Vehicle Maintenances)'.'In Progress', varTheme.Primary,
                                        'Status (Vehicle Maintenances)'.Closed, varStatusColors.Available,
                                        varTheme.TextSecondary
                                    )
                                )
                              Height: =Parent.Height
                              Width: =4
                        - lblMaintRowVehicle:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextPrimary
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =11
                              Text: =ThisItem.Vehicle.'Vehicle Name'
                              Width: =140
                              X: =24
                        - lblMaintRowType:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =10
                              Text: =Concat(ThisItem.Type, Value, ", ")
                              Width: =140
                              X: =164
                        - lblMaintRowDesc:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =10
                              Text: =ThisItem.Description
                              Width: =180
                              X: =304
                        - lblMaintRowStatus:
                            Control: Label@2.5.1
                            Properties:
                              Color: |-
                                =Switch(
                                    ThisItem.'Status (cr63e_status)',
                                    'Status (Vehicle Maintenances)'.Open, varStatusColors.Warning,
                                    'Status (Vehicle Maintenances)'.'In Progress', varTheme.Primary,
                                    'Status (Vehicle Maintenances)'.Closed, varStatusColors.Available,
                                    varTheme.TextSecondary
                                )
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =10
                              Text: =Upper(Text(ThisItem.'Status (cr63e_status)'))
                              Width: =90
                              X: =484
                        - lblMaintRowOOS:
                            Control: Label@2.5.1
                            Properties:
                              Color: =If(ThisItem.OutOfService, varStatusColors.OutOfService, varTheme.TextSecondary)
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =10
                              Text: =If(ThisItem.OutOfService, "YES", "No")
                              Width: =100
                              X: =574
                        - lblMaintRowReporter:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =10
                              Text: =ThisItem.ReportedBy.Associate
                              Width: =110
                              X: =674
                        - lblMaintRowDate:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =10
                              Text: =Text(ThisItem.ReportedDateTime, "mmm d, yyyy")
                              Width: =90
                              X: =784
                        - btnMaintAdvance:
                            Control: Button@0.0.45
                            Properties:
                              BasePaletteColor: |-
                                =Switch(
                                    ThisItem.'Status (cr63e_status)',
                                    'Status (Vehicle Maintenances)'.Open, varTheme.Primary,
                                    'Status (Vehicle Maintenances)'.'In Progress', varStatusColors.Available,
                                    varTheme.TextSecondary
                                )
                              FontSize: =9
                              Height: =26
                              OnSelect: |-
                                =If(
                                    ThisItem.'Status (cr63e_status)' = 'Status (Vehicle Maintenances)'.Open,
                                    // Open -> In Progress
                                    Patch(
                                        'Vehicle Maintenances',
                                        ThisItem,
                                        {
                                            'Status (cr63e_status)': 'Status (Vehicle Maintenances)'.'In Progress'
                                        }
                                    ),
                                    ThisItem.'Status (cr63e_status)' = 'Status (Vehicle Maintenances)'.'In Progress',
                                    // In Progress -> Closed
                                    Patch(
                                        'Vehicle Maintenances',
                                        ThisItem,
                                        {
                                            'Status (cr63e_status)': 'Status (Vehicle Maintenances)'.Closed,
                                            OutOfService: false
                                        }
                                    );
                                    // Set vehicle back to Available if it was in Maintenance
                                    If(
                                        ThisItem.Vehicle.'Status (cr63e_status)' = 'Status (CFSVehicles)'.Maintenance,
                                        Patch(
                                            CFSVehicles,
                                            ThisItem.Vehicle,
                                            {
                                                'Status (cr63e_status)': 'Status (CFSVehicles)'.Available
                                            }
                                        )
                                    )
                                );
                                ClearCollect(
                                    colAdminMaintenance,
                                    Sort('Vehicle Maintenances', ReportedDateTime, SortOrder.Descending)
                                )
                              Text: |-
                                =Switch(
                                    ThisItem.'Status (cr63e_status)',
                                    'Status (Vehicle Maintenances)'.Open, "Start",
                                    'Status (Vehicle Maintenances)'.'In Progress', "Close",
                                    ""
                                )
                              Visible: =ThisItem.'Status (cr63e_status)' <> 'Status (Vehicle Maintenances)'.Closed
                              Width: =50
                              X: =Parent.Width - 118
                              Y: =12
                        - btnMaintOOS:
                            Control: Button@0.0.45
                            Properties:
                              Appearance: ="Secondary"
                              BasePaletteColor: =If(ThisItem.OutOfService, varStatusColors.Available, varStatusColors.OutOfService)
                              FontSize: =9
                              Height: =26
                              OnSelect: |-
                                =Patch(
                                    'Vehicle Maintenances',
                                    ThisItem,
                                    {
                                        OutOfService: !ThisItem.OutOfService
                                    }
                                );
                                // Update vehicle status accordingly
                                If(
                                    !ThisItem.OutOfService,
                                    // Setting to OOS - put vehicle in maintenance
                                    Patch(
                                        CFSVehicles,
                                        ThisItem.Vehicle,
                                        {
                                            'Status (cr63e_status)': 'Status (CFSVehicles)'.Maintenance
                                        }
                                    ),
                                    // Removing OOS - check if any other OOS maintenance exists
                                    If(
                                        CountRows(
                                            Filter(
                                                'Vehicle Maintenances',
                                                Vehicle.CFSVehicles = ThisItem.Vehicle.CFSVehicles &&
                                                OutOfService &&
                                                'Status (cr63e_status)' <> 'Status (Vehicle Maintenances)'.Closed &&
                                                'Vehicle Maintenances' <> ThisItem.'Vehicle Maintenances'
                                            )
                                        ) = 0,
                                        Patch(
                                            CFSVehicles,
                                            ThisItem.Vehicle,
                                            {
                                                'Status (cr63e_status)': 'Status (CFSVehicles)'.Available
                                            }
                                        )
                                    )
                                );
                                ClearCollect(
                                    colAdminMaintenance,
                                    Sort('Vehicle Maintenances', ReportedDateTime, SortOrder.Descending)
                                )
                              Text: =If(ThisItem.OutOfService, "In Svc", "OOS")
                              Visible: =ThisItem.'Status (cr63e_status)' <> 'Status (Vehicle Maintenances)'.Closed
                              Width: =50
                              X: =Parent.Width - 62
                              Y: =12
                        - recMaintRowDivider:
                            Control: Rectangle@2.3.0
                            Properties:
                              Fill: =varTheme.Border
                              Height: =1
                              Width: =Parent.Width - 24
                              X: =24
                              Y: =Parent.Height - 1
