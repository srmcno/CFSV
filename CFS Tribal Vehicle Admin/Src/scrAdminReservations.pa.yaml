# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  scrAdminReservations:
    Properties:
      Fill: =varTheme.Background
      LoadingSpinnerColor: =varTheme.Primary
      OnVisible: |-
        =Set(varActiveScreen, "Reservations");
        Set(varResFilterStatus, "All");
        Set(varResFilterStart, Today() - 30);
        Set(varResFilterEnd, Today() + 30);
        Set(varShowResForm, false);
        Set(varIsNewRes, false);
        Set(varSelectedReservation, Blank());

        ClearCollect(
            colAdminReservations,
            Sort(
                'Vehicle Reservations',
                StartDateTime,
                SortOrder.Descending
            )
        );
    Children:
      - cmpAdminNav_Reservations:
          Control: CanvasComponent
          ComponentName: cmpAdminNav
          Properties:
            ActiveScreen: ="Reservations"
            Height: =Parent.Height
            Width: =220
      - cnrResContent:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =varTheme.Background
            Height: =Parent.Height
            PaddingBottom: =0
            PaddingLeft: =0
            Width: =Parent.Width - 220
            X: =220
          Children:
            - cnrResHeader:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  Height: =64
                  PaddingBottom: =0
                  PaddingLeft: =0
                  Width: =Parent.Width
                Children:
                  - lblResTitle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =40
                        PaddingLeft: =8
                        Size: =20
                        Text: ="Reservation Management"
                        Width: =400
                        X: =24
                        Y: =12
                  - lblResSubtitle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =20
                        Size: =12
                        Text: =CountRows(colAdminReservations) & " total reservations"
                        Width: =300
                        X: =24
                        Y: =40
                  - btnCreateReservation:
                      Control: Button@0.0.45
                      Properties:
                        Height: =36
                        OnSelect: |-
                          =Set(varIsNewRes, true);
                          Set(varSelectedReservation, Blank());
                          Set(varShowResForm, true)
                        Text: ="+ Create Reservation"
                        Width: =170
                        X: =Parent.Width - 194
                        Y: =14
            - cnrResFilters:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  Height: =52
                  PaddingBottom: =0
                  PaddingLeft: =0
                  Width: =Parent.Width
                  Y: =64
                Children:
                  - ddResStatusFilter:
                      Control: DropDown@0.0.45
                      Properties:
                        Height: =36
                        Items: =["All", "Draft", "Submitted", "Approved", "CheckedOut", "Returned", "Cancelled", "NoShow"]
                        OnChange: =Set(varResFilterStatus, Self.Selected.Value)
                        Width: =180
                        X: =24
                        Y: =8
                  - lblResDateFrom:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =36
                        Size: =11
                        Text: ="From:"
                        Width: =40
                        X: =220
                        Y: =8
                  - dpResFilterStart:
                      Control: DatePicker@0.0.46
                      Properties:
                        Height: =36
                        SelectedDate: =varResFilterStart
                        Width: =180
                        X: =264
                        Y: =8
                  - lblResDateTo:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =36
                        Size: =11
                        Text: ="To:"
                        Width: =30
                        X: =460
                        Y: =8
                  - dpResFilterEnd:
                      Control: DatePicker@0.0.46
                      Properties:
                        Height: =36
                        SelectedDate: =varResFilterEnd
                        Width: =180
                        X: =494
                        Y: =8
            - cnrResTableHeader:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Background
                  Height: =36
                  PaddingBottom: =0
                  PaddingLeft: =0
                  Width: =Parent.Width
                  Y: =116
                Children:
                  - lblResColVehicle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Vehicle"
                        Width: =140
                        X: =24
                  - lblResColAssociate:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Associate"
                        Width: =130
                        X: =164
                  - lblResColStart:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Start Date"
                        Width: =120
                        X: =294
                  - lblResColEnd:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="End Date"
                        Width: =120
                        X: =414
                  - lblResColPurpose:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Purpose"
                        Width: =140
                        X: =534
                  - lblResColStatus:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Status"
                        Width: =90
                        X: =674
                  - lblResColActions:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =varTheme.TextSecondary
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        Size: =11
                        Text: ="Actions"
                        Width: =160
                        X: =Parent.Width - 184
            - galResTable:
                Control: Gallery@2.15.0
                Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
                Properties:
                  BorderColor: =varTheme.Border
                  Height: =Parent.Height - 152
                  Items: |-
                    =Sort(
                        Filter(
                            colAdminReservations,
                            (varResFilterStatus = "All" || Text('Status (cr63e_status)') = varResFilterStatus) &&
                            StartDateTime >= varResFilterStart &&
                            StartDateTime <= varResFilterEnd
                        ),
                        StartDateTime,
                        SortOrder.Descending
                    )
                  LoadingSpinner: =LoadingSpinner.Controls
                  TemplatePadding: =1
                  TemplateSize: =46
                  Width: =Parent.Width
                  Y: =152
                Children:
                  - cnrResTableRow:
                      Control: GroupContainer@1.4.0
                      Variant: ManualLayout
                      Properties:
                        Fill: =varTheme.Surface
                        Height: =Parent.TemplateHeight - 2
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Width: =Parent.TemplateWidth
                      Children:
                        - recResRowAccent:
                            Control: Rectangle@2.3.0
                            Properties:
                              Fill: |-
                                =Switch(
                                    ThisItem.'Status (cr63e_status)',
                                    'Status (Vehicle Reservations)'.Draft, varStatusColors.Draft,
                                    'Status (Vehicle Reservations)'.Submitted, varStatusColors.Submitted,
                                    'Status (Vehicle Reservations)'.Approved, varStatusColors.Approved,
                                    'Status (Vehicle Reservations)'.CheckedOut, varStatusColors.CheckedOut,
                                    'Status (Vehicle Reservations)'.Returned, varStatusColors.Available,
                                    'Status (Vehicle Reservations)'.Cancelled, varStatusColors.Cancelled,
                                    'Status (Vehicle Reservations)'.NoShow, varStatusColors.Maintenance,
                                    RGBA(96, 94, 92, 1)
                                )
                              Height: =Parent.Height
                              Width: =4
                        - lblResRowVehicle:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextPrimary
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =11
                              Text: =ThisItem.Vehicle.'Vehicle Name'
                              Width: =140
                              X: =24
                        - lblResRowAssociate:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =11
                              Text: =ThisItem.Associate.Associate
                              Width: =130
                              X: =164
                        - lblResRowStart:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =11
                              Text: =Text(ThisItem.StartDateTime, "mmm d, yyyy")
                              Width: =120
                              X: =294
                        - lblResRowEnd:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =11
                              Text: =Text(ThisItem.EndDateTime, "mmm d, yyyy")
                              Width: =120
                              X: =414
                        - lblResRowPurpose:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =Parent.Height
                              Size: =10
                              Text: =ThisItem.Purpose
                              Width: =140
                              X: =534
                        - lblResRowStatus:
                            Control: Label@2.5.1
                            Properties:
                              Color: =recResRowAccent.Fill
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =10
                              Text: =Upper(Text(ThisItem.'Status (cr63e_status)'))
                              Width: =90
                              X: =674
                        - btnResApprove:
                            Control: Button@0.0.45
                            Properties:
                              BasePaletteColor: =varStatusColors.Available
                              FontSize: =10
                              Height: =28
                              OnSelect: |-
                                =Patch(
                                    'Vehicle Reservations',
                                    ThisItem,
                                    {
                                        'Status (cr63e_status)': 'Status (Vehicle Reservations)'.Approved
                                    }
                                );
                                ClearCollect(
                                    colAdminReservations,
                                    Sort('Vehicle Reservations', StartDateTime, SortOrder.Descending)
                                )
                              Text: ="Approve"
                              Visible: =ThisItem.'Status (cr63e_status)' = 'Status (Vehicle Reservations)'.Submitted
                              Width: =68
                              X: =Parent.Width - 178
                              Y: =8
                        - btnResReject:
                            Control: Button@0.0.45
                            Properties:
                              BasePaletteColor: =varStatusColors.Cancelled
                              FontSize: =10
                              Height: =28
                              OnSelect: |-
                                =Patch(
                                    'Vehicle Reservations',
                                    ThisItem,
                                    {
                                        'Status (cr63e_status)': 'Status (Vehicle Reservations)'.Cancelled
                                    }
                                );
                                ClearCollect(
                                    colAdminReservations,
                                    Sort('Vehicle Reservations', StartDateTime, SortOrder.Descending)
                                )
                              Text: ="Reject"
                              Visible: =ThisItem.'Status (cr63e_status)' = 'Status (Vehicle Reservations)'.Submitted
                              Width: =60
                              X: =Parent.Width - 100
                              Y: =8
                        - btnResCheckOut:
                            Control: Button@0.0.45
                            Properties:
                              BasePaletteColor: =varTheme.Primary
                              FontSize: =10
                              Height: =28
                              OnSelect: |-
                                =Patch(
                                    'Vehicle Reservations',
                                    ThisItem,
                                    {
                                        'Status (cr63e_status)': 'Status (Vehicle Reservations)'.CheckedOut
                                    }
                                );
                                // Create checkout record
                                Patch(
                                    'Vehicle Checkouts',
                                    Defaults('Vehicle Checkouts'),
                                    {
                                        Vehicle: ThisItem.Vehicle,
                                        Associate: ThisItem.Associate,
                                        CheckedOutAt: Now()
                                    }
                                );
                                // Update vehicle status
                                Patch(
                                    CFSVehicles,
                                    ThisItem.Vehicle,
                                    {
                                        'Status (cr63e_status)': 'Status (CFSVehicles)'.'Checked Out'
                                    }
                                );
                                ClearCollect(
                                    colAdminReservations,
                                    Sort('Vehicle Reservations', StartDateTime, SortOrder.Descending)
                                )
                              Text: ="Check Out"
                              Visible: =ThisItem.'Status (cr63e_status)' = 'Status (Vehicle Reservations)'.Approved
                              Width: =80
                              X: =Parent.Width - 104
                              Y: =8
                        - btnResReturn:
                            Control: Button@0.0.45
                            Properties:
                              BasePaletteColor: =varStatusColors.Available
                              FontSize: =10
                              Height: =28
                              OnSelect: |-
                                =Patch(
                                    'Vehicle Reservations',
                                    ThisItem,
                                    {
                                        'Status (cr63e_status)': 'Status (Vehicle Reservations)'.Returned
                                    }
                                );
                                // Update checkout record
                                Patch(
                                    'Vehicle Checkouts',
                                    LookUp(
                                        'Vehicle Checkouts',
                                        Vehicle.CFSVehicles = ThisItem.Vehicle.CFSVehicles &&
                                        Associate.Associates = ThisItem.Associate.Associates &&
                                        IsBlank(ReturnedAt)
                                    ),
                                    {
                                        ReturnedAt: Now()
                                    }
                                );
                                // Set vehicle back to available
                                Patch(
                                    CFSVehicles,
                                    ThisItem.Vehicle,
                                    {
                                        'Status (cr63e_status)': 'Status (CFSVehicles)'.Available
                                    }
                                );
                                ClearCollect(
                                    colAdminReservations,
                                    Sort('Vehicle Reservations', StartDateTime, SortOrder.Descending)
                                )
                              Text: ="Return"
                              Visible: =ThisItem.'Status (cr63e_status)' = 'Status (Vehicle Reservations)'.CheckedOut
                              Width: =70
                              X: =Parent.Width - 94
                              Y: =8
                        - btnResNoShow:
                            Control: Button@0.0.45
                            Properties:
                              Appearance: ="Secondary"
                              FontSize: =10
                              Height: =28
                              OnSelect: |-
                                =Patch(
                                    'Vehicle Reservations',
                                    ThisItem,
                                    {
                                        'Status (cr63e_status)': 'Status (Vehicle Reservations)'.NoShow
                                    }
                                );
                                ClearCollect(
                                    colAdminReservations,
                                    Sort('Vehicle Reservations', StartDateTime, SortOrder.Descending)
                                )
                              Text: ="No Show"
                              Visible: =ThisItem.'Status (cr63e_status)' = 'Status (Vehicle Reservations)'.Approved && ThisItem.StartDateTime < Today()
                              Width: =70
                              X: =Parent.Width - 178
                              Y: =8
                        - recResRowDivider:
                            Control: Rectangle@2.3.0
                            Properties:
                              Fill: =varTheme.Border
                              Height: =1
                              Width: =Parent.Width - 24
                              X: =24
                              Y: =Parent.Height - 1
      - cnrResFormOverlay:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =RGBA(0, 0, 0, 0.5)
            Height: =Parent.Height
            PaddingBottom: =0
            PaddingLeft: =0
            Visible: =varShowResForm
            Width: =Parent.Width
          Children:
            - cnrResFormModal:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  Height: =520
                  PaddingBottom: =0
                  PaddingLeft: =0
                  RadiusBottomLeft: =12
                  RadiusBottomRight: =12
                  RadiusTopLeft: =12
                  RadiusTopRight: =12
                  Width: =480
                  X: =(Parent.Width - 480) / 2
                  Y: =(Parent.Height - 520) / 2
                Children:
                  - lblResFormTitle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =40
                        PaddingLeft: =8
                        Size: =18
                        Text: ="Create Reservation"
                        Width: =360
                        X: =24
                        Y: =16
                  - btnResFormClose:
                      Control: Button@0.0.45
                      Properties:
                        Appearance: ="Transparent"
                        FontColor: =varTheme.TextSecondary
                        Height: =36
                        OnSelect: =Set(varShowResForm, false)
                        Text: ="X"
                        Width: =36
                        X: =Parent.Width - 52
                        Y: =16
                  - recResFormDivider:
                      Control: Rectangle@2.3.0
                      Properties:
                        Fill: =varTheme.Border
                        Height: =1
                        Width: =Parent.Width - 48
                        X: =24
                        Y: =56
                  - lblResFormVehicle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =24
                        Size: =12
                        Text: ="Vehicle *"
                        Width: =200
                        X: =24
                        Y: =68
                  - ddResFormVehicle:
                      Control: DropDown@0.0.45
                      Properties:
                        Height: =36
                        Items: =Sort(CFSVehicles, 'Vehicle Name')
                        Width: =416
                        X: =24
                        Y: =92
                  - lblResFormAssociate:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =24
                        Size: =12
                        Text: ="Associate *"
                        Width: =200
                        X: =24
                        Y: =140
                  - ddResFormAssociate:
                      Control: DropDown@0.0.45
                      Properties:
                        Height: =36
                        Items: =Sort(Associates, Associate)
                        Width: =416
                        X: =24
                        Y: =164
                  - lblResFormStart:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =24
                        Size: =12
                        Text: ="Start Date *"
                        Width: =200
                        X: =24
                        Y: =212
                  - dpResFormStart:
                      Control: DatePicker@0.0.46
                      Properties:
                        Height: =36
                        SelectedDate: =Today()
                        Width: =200
                        X: =24
                        Y: =236
                  - lblResFormEnd:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =24
                        Size: =12
                        Text: ="End Date *"
                        Width: =200
                        X: =240
                        Y: =212
                  - dpResFormEnd:
                      Control: DatePicker@0.0.46
                      Properties:
                        Height: =36
                        SelectedDate: =Today()
                        Width: =200
                        X: =240
                        Y: =236
                  - lblResFormPurpose:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =24
                        Size: =12
                        Text: ="Purpose"
                        Width: =200
                        X: =24
                        Y: =284
                  - txtResFormPurpose:
                      Control: TextInput@0.0.54
                      Properties:
                        Height: =60
                        Mode: =TextMode.MultiLine
                        Placeholder: ="Enter reservation purpose..."
                        Width: =416
                        X: =24
                        Y: =308
                  - lblResFormStatus:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =24
                        Size: =12
                        Text: ="Initial Status"
                        Width: =200
                        X: =24
                        Y: =380
                  - ddResFormStatus:
                      Control: DropDown@0.0.45
                      Properties:
                        DefaultSelectedItems: =["Approved"]
                        Height: =36
                        Items: =["Draft", "Submitted", "Approved"]
                        Width: =200
                        X: =24
                        Y: =404
                  - recResFormBottomDivider:
                      Control: Rectangle@2.3.0
                      Properties:
                        Fill: =varTheme.Border
                        Height: =1
                        Width: =Parent.Width - 48
                        X: =24
                        Y: =456
                  - btnResFormCancel:
                      Control: Button@0.0.45
                      Properties:
                        Appearance: ="Secondary"
                        Height: =40
                        OnSelect: =Set(varShowResForm, false)
                        Text: ="Cancel"
                        Width: =120
                        X: =Parent.Width - 280
                        Y: =468
                  - btnResFormSave:
                      Control: Button@0.0.45
                      Properties:
                        Height: =40
                        OnSelect: |-
                          =Set(varIsSubmitting, true);
                          Patch(
                              'Vehicle Reservations',
                              Defaults('Vehicle Reservations'),
                              {
                                  Vehicle: ddResFormVehicle.Selected,
                                  Associate: ddResFormAssociate.Selected,
                                  StartDateTime: dpResFormStart.SelectedDate,
                                  EndDateTime: dpResFormEnd.SelectedDate,
                                  Purpose: txtResFormPurpose.Value,
                                  'Reserved By': varUserDisplayName
                              }
                          );
                          Set(varIsSubmitting, false);
                          Set(varShowResForm, false);
                          ClearCollect(
                              colAdminReservations,
                              Sort('Vehicle Reservations', StartDateTime, SortOrder.Descending)
                          )
                        Text: =If(varIsSubmitting, "Saving...", "Create Reservation")
                        Width: =140
                        X: =Parent.Width - 148
                        Y: =468
