# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  scrVehicleDetail:
    Properties:
      Fill: =varTheme.Background
      LoadingSpinnerColor: =RGBA(98, 100, 167, 1)
      OnVisible: "=// Load reservations for this vehicle\r\n        ClearCollect(\r\n            colVehicleReservations,\r\n            Filter(\r\n                'Vehicle Reservations',\r\n                Vehicle.CFSVehicles = varSelectedVehicle.CFSVehicles &&\r\n                EndDateTime >= Today()\r\n            )\r\n        );\r\n        \r\n        // Get fuel card info\r\n        Set(\r\n            varVehicleFuelCard,\r\n            LookUp(\r\n                'Fuel Card Assignments',\r\n                Vehicle.CFSVehicles = varSelectedVehicle.CFSVehicles\r\n            )\r\n        );"
    Children:
      - cmpHeader_Detail:
          Control: CanvasComponent
          ComponentName: cmpHeader
          Properties:
            Height: =84
            ShowBackBtn: =true
            SubTitle: =varSelectedVehicle.Year & " " & varSelectedVehicle.Make & " " & varSelectedVehicle.Model
            Title: =varSelectedVehicle.'Vehicle Name'
            Width: =App.Width
      - cmpBottomNav_Detail:
          Control: CanvasComponent
          ComponentName: cmpBottomNav
          Properties:
            ActiveKey: ="Vehicles"
            Height: =72
            Width: =App.Width
            Y: =Parent.Height - Self.Height
      - cnrDetailScroll:
          Control: GroupContainer@1.4.0
          Variant: AutoLayout
          Properties:
            Fill: =Color.Transparent
            Height: =Parent.Height - cmpHeader_Detail.Height - cmpBottomNav_Detail.Height
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =16
            LayoutOverflowY: =LayoutOverflow.Scroll
            PaddingBottom: =24
            Width: =Parent.Width
            Y: =cmpHeader_Detail.Height
          Children:
            # ── Status Banner ────────────────────────────────────────────────
            - cnrStatusBanner:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  AlignInContainer: =AlignInContainer.SetByContainer
                  Fill: |-
                    =Switch(
                        Text(varSelectedVehicle.'Status (cr63e_status)'),
                        "Available", varStatusColors.Available,
                        "Checked Out", varStatusColors.CheckedOut,
                        "Reserved", varStatusColors.Reserved,
                        "Maintenance", varStatusColors.Maintenance,
                        RGBA(96, 94, 92, 1)
                    )
                  FillPortions: =0
                  Height: =40
                  Width: =Parent.Width
                Children:
                  - lblStatusBannerText:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =RGBA(255, 255, 255, 1)
                        FontWeight: =FontWeight.Semibold
                        Height: =Parent.Height
                        Size: =14
                        Text: =Upper(Text(varSelectedVehicle.'Status (cr63e_status)'))
                        Width: =Parent.Width

            # ── Vehicle Info Card ────────────────────────────────────────────
            - cnrInfoCard:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  AlignInContainer: =AlignInContainer.SetByContainer
                  Fill: =varTheme.Surface
                  FillPortions: =0
                  Height: =If(Text(varSelectedVehicle.'Status (cr63e_status)') = "Checked Out", 196, 170)
                  RadiusBottomLeft: =16
                  RadiusBottomRight: =16
                  RadiusTopLeft: =16
                  RadiusTopRight: =16
                  Width: =Parent.Width - 32
                Children:
                  # ── Row 1: Tag ──
                  - lblTagLabel:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =26
                        Size: =12
                        Text: ="Tag"
                        Width: =140
                        X: =16
                        Y: =12
                  - lblTagValue:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Right
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =26
                        Size: =12
                        Text: =If(!IsBlank(varSelectedVehicle.Tag), varSelectedVehicle.Tag, "—")
                        Width: =Parent.Width - 172
                        X: =156
                        Y: =12

                  # ── Row 2: VIN ──
                  - lblVINLabel:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =26
                        Size: =12
                        Text: ="VIN"
                        Width: =140
                        X: =16
                        Y: =38
                  - lblVINValue:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Right
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =26
                        Size: =12
                        Text: =If(!IsBlank(varSelectedVehicle.VIN), varSelectedVehicle.VIN, "—")
                        Width: =Parent.Width - 172
                        X: =156
                        Y: =38

                  # ── Row 3: Assigned Office ──
                  - lblOfficeLabel:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =26
                        Size: =12
                        Text: ="Assigned Office"
                        Width: =140
                        X: =16
                        Y: =64
                  - lblOfficeValue:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Right
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =26
                        Size: =12
                        Text: =If(!IsBlank(varSelectedVehicle.Location), varSelectedVehicle.Location, "—")
                        Width: =Parent.Width - 172
                        X: =156
                        Y: =64

                  # ── Row 4: Fuel Card (Last 4) ──
                  - lblFuelCardLabel:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =26
                        Size: =12
                        Text: ="Fuel Card (Last 4)"
                        Width: =140
                        X: =16
                        Y: =90
                  - lblFuelCardValue:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Right
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =26
                        Size: =12
                        Text: =If(IsBlank(varVehicleFuelCard), "Not Assigned", "****" & varVehicleFuelCard.CardLast4)
                        Width: =Parent.Width - 172
                        X: =156
                        Y: =90

                  # ── Row 5: Current Mileage ──
                  - lblMileageLabel:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =26
                        Size: =12
                        Text: ="Current Mileage"
                        Width: =140
                        X: =16
                        Y: =116
                  - lblMileageValue:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Right
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =26
                        Size: =12
                        Text: =Text(varSelectedVehicle.'Current Mileage', "#,##0") & " mi"
                        Width: =Parent.Width - 172
                        X: =156
                        Y: =116

                  # ── Divider above checked-out-by ──
                  - recInfoDivider:
                      Control: Rectangle@2.3.0
                      Properties:
                        Fill: =varTheme.Divider
                        Height: =1
                        Visible: =Text(varSelectedVehicle.'Status (cr63e_status)') = "Checked Out"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =148

                  # ── Row 6: Checked out by (conditional) ──
                  - lblCheckedOutBy:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.Danger
                        FontWeight: =FontWeight.Semibold
                        Height: =26
                        Size: =12
                        Text: |-
                          ="Checked out by: " & LookUp('Vehicle Checkouts', Vehicle.CFSVehicles = varSelectedVehicle.CFSVehicles && IsBlank(ReturnedAt)).Associate.Associate
                        Visible: =Text(varSelectedVehicle.'Status (cr63e_status)') = "Checked Out"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =156

            # ── Action Buttons ───────────────────────────────────────────────
            - cnrActions:
                Control: GroupContainer@1.4.0
                Variant: AutoLayout
                Properties:
                  AlignInContainer: =AlignInContainer.SetByContainer
                  FillPortions: =0
                  Height: =52
                  LayoutAlignItems: =LayoutAlignItems.Stretch
                  LayoutDirection: =LayoutDirection.Horizontal
                  LayoutGap: =12
                  PaddingLeft: =16
                  PaddingRight: =16
                  Visible: =Text(varSelectedVehicle.'Status (cr63e_status)') = "Available" || Text(varSelectedVehicle.'Status (cr63e_status)') = "Checked Out"
                  Width: =Parent.Width
                Children:
                  - btnReserve:
                      Control: Button@0.0.45
                      Properties:
                        BasePaletteColor: =varTheme.Primary
                        FillPortions: =1
                        Height: =52
                        OnSelect: |-
                          =Set(varIsNewReservation, true);
                          Navigate(scrReservation, ScreenTransition.Fade)
                        Text: ="Reserve"
                        Visible: =Text(varSelectedVehicle.'Status (cr63e_status)') = "Available"
                  - btnCheckOut:
                      Control: Button@0.0.45
                      Properties:
                        BasePaletteColor: =varStatusColors.CheckedOut
                        FillPortions: =1
                        Height: =52
                        OnSelect: |-
                          =Patch(
                              'Vehicle Checkouts',
                              Defaults('Vehicle Checkouts'),
                              {
                                  Vehicle: varSelectedVehicle,
                                  Associate: varUserAssociate,
                                  CheckedOutAt: Now()
                              }
                          );

                          Patch(
                              CFSVehicles,
                              varSelectedVehicle,
                              {'Status (cr63e_status)': 'Status (CFSVehicles)'.'Checked Out'}
                          );

                          Notify("Vehicle checked out!", NotificationType.Success);
                          Navigate(scrVehicleList, ScreenTransition.Fade)
                        Text: ="Check Out"
                        Visible: =Text(varSelectedVehicle.'Status (cr63e_status)') = "Available"
                  - btnCheckIn:
                      Control: Button@0.0.45
                      Properties:
                        BasePaletteColor: =varStatusColors.Available
                        FillPortions: =1
                        Height: =52
                        OnSelect: |-
                          =With(
                              {openCheckout: LookUp('Vehicle Checkouts', Vehicle.CFSVehicles = varSelectedVehicle.CFSVehicles && IsBlank(ReturnedAt))},
                              If(
                                  !IsBlank(openCheckout),
                                  Patch('Vehicle Checkouts', openCheckout, {ReturnedAt: Now()})
                              )
                          );

                          Patch(
                              CFSVehicles,
                              varSelectedVehicle,
                              {'Status (cr63e_status)': 'Status (CFSVehicles)'.Available}
                          );

                          Notify("Vehicle checked in!", NotificationType.Success);
                          Navigate(scrVehicleList, ScreenTransition.Fade)
                        Text: ="Check In Vehicle"
                        Visible: =Text(varSelectedVehicle.'Status (cr63e_status)') = "Checked Out"

            # ── Upcoming Reservations Header ─────────────────────────────────
            - cnrUpcomingHeader:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  AlignInContainer: =AlignInContainer.SetByContainer
                  FillPortions: =0
                  Height: =28
                  Visible: =CountRows(colVehicleReservations) > 0
                  Width: =Parent.Width - 32
                Children:
                  - lblUpcomingTitle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =28
                        Size: =14
                        Text: ="Upcoming Reservations"
                        Width: =Parent.Width

            # ── Upcoming Reservations Gallery ────────────────────────────────
            - galUpcoming:
                Control: Gallery@2.15.0
                Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
                Properties:
                  AlignInContainer: =AlignInContainer.SetByContainer
                  BorderColor: =RGBA(243, 242, 241, 1)
                  FillPortions: =0
                  FocusedBorderColor: =RGBA(98, 100, 167, 1)
                  FocusedBorderThickness: =2
                  Height: =Min(CountRows(colVehicleReservations) * 64, 256)
                  Items: =colVehicleReservations
                  TemplatePadding: =4
                  TemplateSize: =60
                  Visible: =CountRows(colVehicleReservations) > 0
                  Width: =Parent.Width - 32
                Children:
                  - cnrResItem:
                      Control: GroupContainer@1.4.0
                      Variant: ManualLayout
                      Properties:
                        Fill: =varTheme.PrimaryBg
                        Height: =56
                        RadiusBottomLeft: =10
                        RadiusBottomRight: =10
                        RadiusTopLeft: =10
                        RadiusTopRight: =10
                        Width: =Parent.TemplateWidth
                      Children:
                        - lblResDateRange:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextPrimary
                              FontWeight: =FontWeight.Semibold
                              Height: =24
                              Size: =12
                              Text: =Text(ThisItem.StartDateTime, "mmm d") & " - " & Text(ThisItem.EndDateTime, "mmm d, yyyy")
                              Width: =Parent.Width - 24
                              X: =12
                              Y: =6
                        - lblResBy:
                            Control: Label@2.5.1
                            Properties:
                              Color: =varTheme.TextSecondary
                              Height: =20
                              Size: =10
                              Text: |-
                                ="Reserved by: " & ThisItem.'Reserved By'
                              Width: =Parent.Width - 24
                              X: =12
                              Y: =28

            # ── No Upcoming Reservations ─────────────────────────────────────
            - lblNoReservations:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  AlignInContainer: =AlignInContainer.SetByContainer
                  Color: =varTheme.TextTertiary
                  FillPortions: =0
                  Height: =32
                  Size: =12
                  Text: ="No upcoming reservations"
                  Visible: =CountRows(colVehicleReservations) = 0
                  Width: =Parent.Width - 32

            # ── Maintenance Buttons ──────────────────────────────────────────
            - btnSetMaintenance:
                Control: Button@0.0.45
                Properties:
                  AlignInContainer: =AlignInContainer.SetByContainer
                  Appearance: ="Secondary"
                  BasePaletteColor: =varStatusColors.Maintenance
                  Height: =52
                  OnSelect: |-
                    =Patch(
                        CFSVehicles,
                        varSelectedVehicle,
                        {'Status (cr63e_status)': 'Status (CFSVehicles)'.Maintenance}
                    );
                    Notify("Vehicle set to maintenance", NotificationType.Success);
                    Navigate(scrVehicleList, ScreenTransition.Fade)
                  Text: ="Set Maintenance"
                  VerticalAlign: =VerticalAlign.Middle
                  Visible: =varSelectedVehicle.'Status (cr63e_status)' <> 'Status (CFSVehicles)'.Maintenance
                  Width: =Parent.Width - 32

            - btnClearMaintenance:
                Control: Button@0.0.45
                Properties:
                  AlignInContainer: =AlignInContainer.SetByContainer
                  BasePaletteColor: =varStatusColors.Available
                  Height: =52
                  OnSelect: |-
                    =Patch(
                        CFSVehicles,
                        varSelectedVehicle,
                        {'Status (cr63e_status)': 'Status (CFSVehicles)'.Available}
                    );
                    Notify("Vehicle back to available", NotificationType.Success);
                    Navigate(scrVehicleList, ScreenTransition.Fade)
                  Text: ="Clear Maintenance"
                  Visible: =varSelectedVehicle.'Status (cr63e_status)' = 'Status (CFSVehicles)'.Maintenance
                  Width: =Parent.Width - 32
