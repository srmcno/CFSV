# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
App:
  Properties:
    OnStart: |-
      =// ═══════════════════════════════════════════════
      // CFS Tribal Vehicle Usage v3.0 — Ground-Up Rebuild
      // Choctaw Nation EPS · Mobile-First
      // ═══════════════════════════════════════════════

      // ── Loading flag — screens wait for this ──
      Set(varAppReady, false);

      // ── User Context (with null safety) ──
      Set(varCurrentUser, User());
      Set(varUserEmail, User().Email);
      Set(varUserDisplayName, User().FullName);
      Set(
          varUserAssociate,
          LookUp(Associates, Associate = varUserDisplayName)
      );
      Set(
          varUserHasProfile,
          !IsBlank(varUserAssociate)
      );

      // ── Time-based greeting (Choctaw morning greeting) ──
      Set(
          varGreeting,
          Switch(
              true,
              Hour(Now()) < 12, "Halito",
              Hour(Now()) < 17, "Good afternoon",
              "Good evening"
          )
      );

      // ── Design System: Theme ──
      Set(
          varTheme,
          {
              Primary: RGBA(13, 110, 253, 1),
              PrimaryDark: RGBA(10, 88, 202, 1),
              PrimaryLight: RGBA(207, 226, 255, 1),
              PrimaryBg: RGBA(239, 246, 255, 1),
              Accent: RGBA(111, 66, 193, 1),
              Success: RGBA(25, 135, 84, 1),
              SuccessLight: RGBA(209, 231, 221, 1),
              Warning: RGBA(255, 170, 0, 1),
              WarningLight: RGBA(255, 243, 205, 1),
              Danger: RGBA(220, 53, 69, 1),
              DangerLight: RGBA(248, 215, 218, 1),
              Background: RGBA(247, 248, 252, 1),
              Surface: RGBA(255, 255, 255, 1),
              SurfaceHover: RGBA(248, 249, 250, 1),
              TextPrimary: RGBA(30, 30, 46, 1),
              TextSecondary: RGBA(100, 107, 121, 1),
              TextTertiary: RGBA(160, 167, 180, 1),
              TextOnPrimary: RGBA(255, 255, 255, 1),
              TextOnDark: RGBA(255, 255, 255, 1),
              Border: RGBA(222, 226, 230, 1),
              BorderLight: RGBA(240, 241, 243, 1),
              Divider: RGBA(240, 241, 243, 1),
              Overlay: RGBA(0, 0, 0, 0.5),
              OverlayLight: RGBA(0, 0, 0, 0.08)
          }
      );

      // ── Design System: Status Colors ──
      Set(
          varStatusColors,
          {
              Available: RGBA(25, 135, 84, 1),
              AvailableBg: RGBA(209, 231, 221, 1),
              CheckedOut: RGBA(220, 53, 69, 1),
              CheckedOutBg: RGBA(248, 215, 218, 1),
              Reserved: RGBA(255, 170, 0, 1),
              ReservedBg: RGBA(255, 243, 205, 1),
              Warning: RGBA(255, 170, 0, 1),
              Maintenance: RGBA(108, 117, 125, 1),
              MaintenanceBg: RGBA(233, 236, 239, 1),
              Draft: RGBA(13, 110, 253, 1),
              Submitted: RGBA(13, 110, 253, 1),
              Approved: RGBA(25, 135, 84, 1),
              Cancelled: RGBA(220, 53, 69, 1),
              OutOfService: RGBA(168, 0, 0, 1)
          }
      );

      // ── Design System: Sizing Tokens ──
      Set(
          varSize,
          {
              HeaderH: 84,
              NavH: 72,
              CardRadius: 16,
              SmallRadius: 10,
              InputH: 48,
              ButtonH: 52,
              TouchMin: 48,
              SpaceXS: 4,
              SpaceSM: 8,
              SpaceMD: 16,
              SpaceLG: 24,
              SpaceXL: 32
          }
      );

      // ── Navigation & Global UI State ──
      Set(varSelectedVehicle, Blank());
      Set(varFilterStatus, "All");
      Set(varIsSubmitting, false);
      Set(varShowSuccess, false);
      Set(varShowAllLocations, false);

      // ── Reservation Form State ──
      Set(varResStartDate, Today());
      Set(varResEndDate, Today());
      Set(varResPurpose, "");
      Set(varResVehicleSelected, Blank());
      Set(varResFilter, "Upcoming");

      // ── Gas Form State ──
      Set(varGasAmount, 0);
      Set(varGasGallons, 0);
      Set(varGasOdometer, 0);
      Set(varGasDate, Today());
      Set(varGasCardLast4, "");
      Set(varGasVehicle, Blank());
      Set(varGasNotes, "");

      // ── Shared action state ──
      Set(varPatchResult, Blank());
      Set(varConfirmCancelRes, Blank());
      Set(varConfirmAction, Blank());

      // ── Maintenance Form State ──
      Set(varMaintVehicle, Blank());
      Set(varMaintDescription, "");
      Set(varMaintUrgency, "Medium");
      Set(varMaintOutOfService, false);

      // ── Fuel History State ──
      Set(varFuelHistoryFilter, "Mine");
      Set(varViewReceipt, Blank());

      // ── Dashboard KPIs (initialized, loaded via Concurrent on Home) ──
      Set(varFuelSpendMonth, 0);
      Set(varActiveCheckouts, 0);
      Set(varOverdueReturns, 0);
      Set(varOpenMaintenance, 0);
      Set(varAvailableCount, 0);
      Set(varCheckedOutCount, 0);
      Set(varReservedCount, 0);
      Set(varMaintenanceCount, 0);
      Set(varTotalVehicles, 0);

      // ── App ready ──
      Set(varAppReady, true);
    Theme: =PowerAppsTheme
