# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  scrGasPurchase:
    Properties:
      Fill: =varTheme.Background
      LoadingSpinnerColor: =RGBA(98, 100, 167, 1)
      OnVisible: |-
        =// Reset all form fields on screen entry
        Set(varGasAmount, 0);
        Set(varGasGallons, 0);
        Set(varGasDate, Today());
        Set(varGasCardLast4, "");
        Set(varGasVehicle, Blank());
        Set(varGasNotes, "");
        Set(varGasOdometer, 0);
        Set(varIsSubmitting, false);
        Set(varPatchResult, Blank());

        // Load fuel card assignments for auto-matching
        ClearCollect(colFuelCards, 'Fuel Card Assignments');

        Reset(addReceiptPhoto)
    Children:
      # ══════════════════════════════════════════════════════════════
      # ── HEADER (84px)
      # ══════════════════════════════════════════════════════════════
      - cmpHeader_Gas:
          Control: CanvasComponent
          ComponentName: cmpHeader
          Properties:
            Height: =84
            ShowBackBtn: =true
            SubTitle: |-
              =If(
                  !IsBlank(varGasVehicle),
                  varGasVehicle.'Vehicle Name',
                  "Enter card or select vehicle"
              )
            Title: ="Log Fuel Purchase"
            Width: =App.Width
      # ══════════════════════════════════════════════════════════════
      # ── BOTTOM NAVIGATION (72px)
      # ══════════════════════════════════════════════════════════════
      - cmpBottomNav_Gas:
          Control: CanvasComponent
          ComponentName: cmpBottomNav
          Properties:
            ActiveKey: ="Gas"
            Height: =72
            Width: =App.Width
            Y: =Parent.Height - Self.Height
      # ══════════════════════════════════════════════════════════════
      # ── SCROLLABLE FORM AREA
      # ══════════════════════════════════════════════════════════════
      - cnrGasForm:
          Control: GroupContainer@1.4.0
          Variant: AutoLayout
          Properties:
            Fill: =Color.Transparent
            Height: =Parent.Height - cmpHeader_Gas.Height - cmpBottomNav_Gas.Height
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =14
            LayoutOverflowY: =LayoutOverflow.Scroll
            PaddingBottom: =20
            PaddingLeft: =20
            PaddingRight: =20
            PaddingTop: =20
            Width: =Parent.Width
            Y: =cmpHeader_Gas.Height
          Children:
            # ──────────────────────────────────────────────────────
            # ── FORM CARD
            # ──────────────────────────────────────────────────────
            - cnrGasCard:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  FillPortions: =0
                  Height: =If(!IsBlank(addReceiptPhoto.Media), 700, 540)
                  PaddingBottom: =0.00
                  PaddingLeft: =0.00
                  RadiusBottomLeft: =16
                  RadiusBottomRight: =16
                  RadiusTopLeft: =16
                  RadiusTopRight: =16
                  Width: =Parent.Width - 40
                Children:
                  # ── Fuel Card Last 4 Label ──
                  - lblCardLast4:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Fuel Card Last 4 *"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =16
                  # ── Fuel Card Last 4 Input ──
                  - txtCardLast4:
                      Control: TextInput@0.0.54
                      Properties:
                        Height: =48
                        OnChange: |-
                          =Set(varGasCardLast4, Self.Value);
                          If(
                              Len(Self.Value) = 4,
                              With(
                                  {matchedCard: LookUp(colFuelCards, CardLast4 = Self.Value)},
                                  If(
                                      !IsBlank(matchedCard),
                                      Set(
                                          varGasVehicle,
                                          LookUp(CFSVehicles, CFSVehicles = matchedCard.Vehicle.CFSVehicles)
                                      ),
                                      Set(varGasVehicle, Blank())
                                  )
                              ),
                              Set(varGasVehicle, Blank())
                          )
                        Placeholder: ="Enter last 4 digits..."
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =40
                  # ── Card Match Feedback ──
                  - lblMatchedVehicle:
                      Control: Label@2.5.1
                      Properties:
                        Color: |-
                          =If(
                              !IsBlank(varGasVehicle),
                              varTheme.Success,
                              varTheme.Danger
                          )
                        FontWeight: |-
                          =If(
                              !IsBlank(varGasVehicle),
                              FontWeight.Semibold,
                              FontWeight.Normal
                          )
                        Height: =24
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: |-
                          =If(
                              !IsBlank(varGasVehicle),
                              Concatenate(Char(9989), " Matched: ", varGasVehicle.'Vehicle Name'),
                              "No vehicle found for this card"
                          )
                        Visible: =Len(varGasCardLast4) >= 4
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =92
                  # ── Transaction Date Label ──
                  - lblGasDate:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Transaction Date *"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =122
                  # ── Transaction Date Picker ──
                  - dpGasDate:
                      Control: DatePicker@0.0.46
                      Properties:
                        Height: =48
                        OnChange: =Set(varGasDate, Self.SelectedDate)
                        SelectedDate: =varGasDate
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =146
                  # ── Amount Label (left half) ──
                  - lblAmount:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Amount ($) *"
                        Width: =(Parent.Width - 48) / 2
                        X: =16
                        Y: =202
                  # ── Gallons Label (right half) ──
                  - lblGallons:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Gallons *"
                        Width: =(Parent.Width - 48) / 2
                        X: =(Parent.Width - 48) / 2 + 32
                        Y: =202
                  # ── Amount Input (left half) ──
                  - txtAmount:
                      Control: TextInput@0.0.54
                      Properties:
                        Height: =48
                        OnChange: =Set(varGasAmount, Value(Self.Value))
                        Placeholder: ="0.00"
                        Type: ="Number"
                        Width: =(Parent.Width - 48) / 2
                        X: =16
                        Y: =226
                  # ── Gallons Input (right half) ──
                  - txtGallons:
                      Control: TextInput@0.0.54
                      Properties:
                        Height: =48
                        OnChange: =Set(varGasGallons, Value(Self.Value))
                        Placeholder: ="0.00"
                        Type: ="Number"
                        Width: =(Parent.Width - 48) / 2
                        X: =(Parent.Width - 48) / 2 + 32
                        Y: =226
                  # ── Price Per Gallon (calculated, divide-by-zero safe) ──
                  - lblPPG:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: |-
                          ="Price/gal: $" & Text(
                              If(varGasGallons > 0, varGasAmount / varGasGallons, 0),
                              "#.000"
                          )
                        Visible: =varGasAmount > 0 && varGasGallons > 0
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =278
                  # ── Notes Label ──
                  - lblNotes:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Notes (optional)"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =306
                  # ── Notes Input ──
                  - txtGasNotes:
                      Control: TextInput@0.0.54
                      Properties:
                        Height: =70
                        Mode: =TextMode.MultiLine
                        OnChange: =Set(varGasNotes, Self.Value)
                        Placeholder: ="Any notes about this purchase..."
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =330
                  # ── Receipt Photo Label ──
                  - lblReceiptLabel:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Receipt Photo (optional)"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =408
                  # ── Receipt Photo Capture Button ──
                  - addReceiptPhoto:
                      Control: AddMedia@2.2.1
                      Properties:
                        BorderColor: =RGBA(0, 0, 0, 0)
                        BorderStyle: =BorderStyle.None
                        BorderThickness: =0
                        Color: =varTheme.TextOnPrimary
                        DisabledBorderColor: =RGBA(0, 0, 0, 0)
                        DisabledColor: =RGBA(200, 198, 196, 1)
                        DisabledFill: =RGBA(243, 242, 241, 1)
                        Fill: =varTheme.Primary
                        Font: =Font.'Segoe UI'
                        HoverBorderColor: =RGBA(0, 0, 0, 0)
                        HoverColor: =varTheme.TextOnPrimary
                        HoverFill: =varTheme.PrimaryDark
                        PressedBorderColor: =RGBA(0, 0, 0, 0)
                        PressedColor: =varTheme.TextOnPrimary
                        PressedFill: =varTheme.PrimaryDark
                        Size: =14
                        Text: ="Capture Receipt"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =432
                  # ── Receipt Image Preview ──
                  - imgReceiptPreview:
                      Control: Image@2.2.3
                      Properties:
                        BorderColor: =RGBA(0, 0, 0, 0)
                        BorderThickness: =0
                        DisabledBorderColor: =RGBA(0, 0, 0, 0)
                        DisabledFill: =RGBA(0, 0, 0, 0)
                        Height: =If(!IsBlank(addReceiptPhoto.Media), 150, 0)
                        HoverBorderColor: =RGBA(0, 0, 0, 0)
                        HoverFill: =RGBA(0, 0, 0, 0)
                        Image: =addReceiptPhoto.Media
                        ImagePosition: =ImagePosition.Fit
                        PressedBorderColor: =RGBA(0, 0, 0, 0)
                        PressedFill: =RGBA(0, 0, 0, 0)
                        RadiusBottomLeft: =8
                        RadiusBottomRight: =8
                        RadiusTopLeft: =8
                        RadiusTopRight: =8
                        Visible: =!IsBlank(addReceiptPhoto.Media)
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =addReceiptPhoto.Y + addReceiptPhoto.Height + 8
            # ──────────────────────────────────────────────────────
            # ── LOADING OVERLAY (covers form while submitting)
            # ──────────────────────────────────────────────────────
            - cnrGasSubmitting:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =RGBA(0, 0, 0, 0.4)
                  FillPortions: =0
                  Height: =Parent.Height
                  PaddingBottom: =0.00
                  PaddingLeft: =0.00
                  Visible: =varIsSubmitting
                  Width: =Parent.Width
                Children:
                  - lblGasSaving:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =RGBA(255, 255, 255, 1)
                        FontWeight: =FontWeight.Bold
                        Size: =16
                        Text: ="Saving purchase..."
                        Width: =Parent.Width
                        Y: =(Parent.Height - 40) / 2
            # ──────────────────────────────────────────────────────
            # ── SUBMIT BUTTON
            # ──────────────────────────────────────────────────────
            - btnSubmitGas:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =varTheme.Primary
                  DisplayMode: |-
                    =If(
                        IsBlank(varGasVehicle) ||
                        varGasAmount <= 0 ||
                        varGasGallons <= 0 ||
                        varIsSubmitting,
                        DisplayMode.Disabled,
                        DisplayMode.Edit
                    )
                  FillPortions: =0
                  Height: =52
                  OnSelect: |-
                    =Set(varIsSubmitting, true);

                    // Build the base record
                    Set(
                        varPatchResult,
                        Patch(
                            'Fuel Transactions',
                            Defaults('Fuel Transactions'),
                            {
                                Vehicle: varGasVehicle,
                                TransactionDateTime: varGasDate,
                                Amount: varGasAmount,
                                Gallons: varGasGallons,
                                Source: 'Source (Fuel Transactions)'.Manual,
                                Notes: varGasNotes,
                                SubmittedBy: varUserAssociate,
                                ReceiptImage: addReceiptPhoto.Media
                            }
                        )
                    );

                    If(
                        IsError(varPatchResult),
                        Notify("Failed to save — check connection and try again", NotificationType.Error);
                        Set(varIsSubmitting, false),
                        Set(varIsSubmitting, false);
                        Notify("Fuel purchase logged!", NotificationType.Success);
                        Navigate(scrHome, ScreenTransition.Fade)
                    )
                  Text: ="Submit Fuel Purchase"
                  Width: =Parent.Width - 40
            # ──────────────────────────────────────────────────────
            # ── CANCEL BUTTON
            # ──────────────────────────────────────────────────────
            - btnCancelGas:
                Control: Button@0.0.45
                Properties:
                  Appearance: ="Secondary"
                  FillPortions: =0
                  Height: =52
                  OnSelect: =Back()
                  Text: ="Cancel"
                  Width: =Parent.Width - 40
