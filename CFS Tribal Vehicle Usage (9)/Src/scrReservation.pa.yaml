# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  scrReservation:
    Properties:
      Fill: =varTheme.Background
      LoadingSpinnerColor: =RGBA(98, 100, 167, 1)
      OnVisible: |-
        =// ── Reset all form fields on arrival ──────────────────────────
        Set(varResStartDate, Today());
        Set(varResEndDate, Today());
        Set(varResPurpose, "");
        Set(varIsSubmitting, false);
        Set(varHasConflict, false);
        Set(varResVehicleSelected,
            If(IsBlank(varSelectedVehicle), Blank(), varSelectedVehicle)
        );

        // ── Evaluate conflict for pre-selected vehicle ─────────────
        If(
            !IsBlank(varSelectedVehicle),
            Set(
                varHasConflict,
                CountRows(
                    Filter(
                        'Vehicle Reservations',
                        Vehicle.CFSVehicles = varSelectedVehicle.CFSVehicles &&
                        !(EndDateTime < Today() || StartDateTime > Today())
                    )
                ) > 0
            )
        )
    Children:
      # ════════════════════════════════════════════════════════════════
      #  HEADER
      # ════════════════════════════════════════════════════════════════
      - cmpHeader_Res:
          Control: CanvasComponent
          ComponentName: cmpHeader
          Properties:
            Height: =84
            ShowBackBtn: =true
            SubTitle: |-
              =If(
                  IsBlank(varResVehicleSelected),
                  "Select a vehicle",
                  varResVehicleSelected.'Vehicle Name'
              )
            Title: ="New Reservation"
            Width: =App.Width

      # ════════════════════════════════════════════════════════════════
      #  BOTTOM NAV
      # ════════════════════════════════════════════════════════════════
      - cmpBottomNav_Res:
          Control: CanvasComponent
          ComponentName: cmpBottomNav
          Properties:
            ActiveKey: ="Reserve"
            Height: =72
            Width: =App.Width
            Y: =Parent.Height - Self.Height

      # ════════════════════════════════════════════════════════════════
      #  SCROLLABLE FORM BODY
      # ════════════════════════════════════════════════════════════════
      - cnrResForm:
          Control: GroupContainer@1.4.0
          Variant: AutoLayout
          Properties:
            Fill: =Color.Transparent
            Height: =Parent.Height - cmpHeader_Res.Height - cmpBottomNav_Res.Height
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =14
            LayoutOverflowY: =LayoutOverflow.Scroll
            PaddingBottom: =20
            PaddingLeft: =20
            PaddingRight: =20
            PaddingTop: =20
            Width: =Parent.Width
            Y: =cmpHeader_Res.Height
          Children:
            # ── FORM CARD ──────────────────────────────────────────────
            - cnrFormCard:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  FillPortions: =0
                  Height: =480
                  PaddingBottom: =0.00
                  PaddingLeft: =0.00
                  RadiusBottomLeft: =16
                  RadiusBottomRight: =16
                  RadiusTopLeft: =16
                  RadiusTopRight: =16
                  Width: =Parent.Width - 40
                Children:
                  # ── Select Vehicle Label ─────────────────────────────
                  - lblSelectVehicle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Select Vehicle *"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =16

                  # ── Vehicle Dropdown ─────────────────────────────────
                  - ddVehicle:
                      Control: DropDown@0.0.45
                      Properties:
                        DefaultSelectedItems: |-
                          =If(!IsBlank(varResVehicleSelected), [varResVehicleSelected], [])
                        Height: =48
                        Items: =Filter(CFSVehicles, 'CFSVehicles (Views)'.'Active CFSVehicles')
                        OnChange: |-
                          =Set(varResVehicleSelected, Self.Selected);

                          // ── Re-evaluate conflict when vehicle changes ──
                          Set(
                              varHasConflict,
                              If(
                                  IsBlank(Self.Selected),
                                  false,
                                  CountRows(
                                      Filter(
                                          'Vehicle Reservations',
                                          Vehicle.CFSVehicles = Self.Selected.CFSVehicles &&
                                          !(EndDateTime < varResStartDate || StartDateTime > varResEndDate)
                                      )
                                  ) > 0
                              )
                          )
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =40
                      Children:
                        - VehicleName1:
                            Control: DropDownDataField@1.5.0
                            Variant: textualColumn
                            IsLocked: true
                            Properties:
                              FieldDisplayName: ="Vehicle"
                              FieldName: ="cr63e_vehiclename"
                              FieldType: ="s"
                              Order: =1

                  # ── Start Date Label ─────────────────────────────────
                  - lblStartDate:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Start Date *"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =100

                  # ── Start Date Picker ────────────────────────────────
                  - dpStartDate:
                      Control: DatePicker@0.0.46
                      Properties:
                        Height: =48
                        OnChange: |-
                          =Set(varResStartDate, Self.SelectedDate);

                          // ── Auto-adjust end date if it falls before new start ──
                          If(
                              varResEndDate < Self.SelectedDate,
                              Set(varResEndDate, Self.SelectedDate)
                          );

                          // ── Re-evaluate conflict after date change ──
                          Set(
                              varHasConflict,
                              If(
                                  IsBlank(varResVehicleSelected),
                                  false,
                                  CountRows(
                                      Filter(
                                          'Vehicle Reservations',
                                          Vehicle.CFSVehicles = varResVehicleSelected.CFSVehicles &&
                                          !(EndDateTime < Self.SelectedDate || StartDateTime > varResEndDate)
                                      )
                                  ) > 0
                              )
                          )
                        SelectedDate: =varResStartDate
                        StartDate: =Today()
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =124

                  # ── End Date Label ───────────────────────────────────
                  - lblEndDate:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="End Date *"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =184

                  # ── End Date Picker ──────────────────────────────────
                  - dpEndDate:
                      Control: DatePicker@0.0.46
                      Properties:
                        Height: =48
                        OnChange: |-
                          =Set(varResEndDate, Self.SelectedDate);

                          // ── Re-evaluate conflict after date change ──
                          Set(
                              varHasConflict,
                              If(
                                  IsBlank(varResVehicleSelected),
                                  false,
                                  CountRows(
                                      Filter(
                                          'Vehicle Reservations',
                                          Vehicle.CFSVehicles = varResVehicleSelected.CFSVehicles &&
                                          !(EndDateTime < varResStartDate || StartDateTime > Self.SelectedDate)
                                      )
                                  ) > 0
                              )
                          )
                        SelectedDate: =varResEndDate
                        StartDate: =Today()
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =208

                  # ── Date Validation Warning ─────────────────────────
                  - lblDateWarning:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.Danger
                        Height: =20
                        PaddingLeft: =2
                        Size: =11
                        Text: ="End date must be on or after start date"
                        Visible: =varResEndDate < varResStartDate
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =260

                  # ── Purpose / Notes Label ────────────────────────────
                  - lblPurpose:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =22
                        PaddingBottom: =2
                        PaddingLeft: =2
                        Size: =12
                        Text: ="Purpose / Notes"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =282

                  # ── Purpose Multiline Input ──────────────────────────
                  - txtPurpose:
                      Control: TextInput@0.0.54
                      Properties:
                        Height: =100
                        Mode: =TextMode.MultiLine
                        OnChange: =Set(varResPurpose, Self.Value)
                        Placeholder: ="Enter purpose of trip..."
                        Value: =varResPurpose
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =306

                  # ── Conflict Warning ─────────────────────────────────
                  - lblConflictWarning:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.Danger
                        FontWeight: =FontWeight.Semibold
                        Height: =36
                        PaddingLeft: =2
                        Size: =11
                        Text: ="Cannot submit \u2014 this vehicle has reservations during selected dates"
                        Visible: =varHasConflict
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =416

            # ── SUBMIT BUTTON ──────────────────────────────────────────
            - btnSubmitRes:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =varTheme.Primary
                  DisplayMode: |-
                    =If(
                        IsBlank(varResVehicleSelected) ||
                        varResEndDate < varResStartDate ||
                        varHasConflict ||
                        varIsSubmitting,
                        DisplayMode.Disabled,
                        DisplayMode.Edit
                    )
                  FillPortions: =0
                  Height: =52
                  OnSelect: |-
                    =Set(varIsSubmitting, true);

                    // ── Create reservation record ──────────────────────
                    Set(
                        varPatchResult,
                        Patch(
                            'Vehicle Reservations',
                            Defaults('Vehicle Reservations'),
                            {
                                Vehicle: varResVehicleSelected,
                                Associate: varUserAssociate,
                                StartDateTime: varResStartDate,
                                EndDateTime: varResEndDate,
                                Purpose: varResPurpose,
                                'Status (cr63e_status)': 'Status (Vehicle Reservations)'.Approved
                            }
                        )
                    );

                    // ── Handle result ──────────────────────────────────
                    If(
                        IsError(varPatchResult),
                        Notify(
                            "Failed to save \u2014 check your connection and try again",
                            NotificationType.Error
                        );
                        Set(varIsSubmitting, false),

                        // ── On success: mark vehicle Reserved if starts today ──
                        If(
                            varResStartDate = Today(),
                            Patch(
                                CFSVehicles,
                                varResVehicleSelected,
                                {'Status (cr63e_status)': 'Status (CFSVehicles)'.Reserved}
                            )
                        );
                        Set(varIsSubmitting, false);
                        Notify("Reservation created!", NotificationType.Success);
                        Navigate(scrMyReservations, ScreenTransition.Fade)
                    )
                  Text: ="Submit Reservation"
                  Width: =Parent.Width - 40

            # ── CANCEL BUTTON ──────────────────────────────────────────
            - btnCancelRes:
                Control: Button@0.0.45
                Properties:
                  Appearance: ="Secondary"
                  FillPortions: =0
                  Height: =52
                  OnSelect: =Back()
                  Text: ="Cancel"
                  Width: =Parent.Width - 40

            # ── SUBMITTING OVERLAY ─────────────────────────────────────
            #    Positioned last so it renders on top of all form content.
            #    Covers the entire form area to block interaction.
            - cnrSubmittingOverlay:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =RGBA(0, 0, 0, 0.4)
                  FillPortions: =0
                  Height: =Parent.Height
                  PaddingBottom: =0.00
                  PaddingLeft: =0.00
                  Visible: =varIsSubmitting
                  Width: =Parent.Width
                Children:
                  - lblSubmittingText:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =RGBA(255, 255, 255, 1)
                        FontWeight: =FontWeight.Bold
                        Height: =40
                        Size: =16
                        Text: ="Submitting..."
                        Width: =Parent.Width
                        Y: =(Parent.Height - 40) / 2
