# ************************************************************************************************
# CFS Tribal Vehicle Usage — scrFuelHistory
# Fuel transaction history screen with filter toggle, source-colored gallery cards,
# receipt overlay, and empty state.
#
# KEY IMPROVEMENTS over prior version:
#   1. NULL GUARD on "Mine" filter — checks varUserHasProfile before filtering by associate
#   2. DIVIDE-BY-ZERO protection — PPG uses If(Gallons > 0, ...) guard
#   3. BETTER RECEIPT OVERLAY — shows vehicle, date, amount, and properly bound Image
#   4. FILTER BAR — pill-track background with two toggle pills
#   5. GALLERY CARDS — left accent bar colored by Source, camera icon colored when receipt exists
#   6. EMPTY STATE — icon circle, title, description, CTA
#   7. OnVisible — sets filter to "Mine", loads colFuelHistory with null guard, clears overlay
#
# Data model:
#   'Fuel Transactions': Vehicle (lookup -> 'Vehicle Name'), TransactionDateTime, Amount,
#   Gallons, Source (OptionSet: Manual | VoyagerFeed | Import), Notes,
#   SubmittedBy (lookup -> Associates via .Associates PK), ReceiptImage
#
# Global variables:
#   varTheme, varStatusColors, varSize
#   varUserAssociate, varUserHasProfile
#   varFuelHistoryFilter ("Mine" | "All")
#   varViewReceipt (fuel transaction record or Blank)
#
# Components: cmpHeader (84px, ShowBackBtn=true), cmpBottomNav (72px, ActiveKey="Gas")
#
# Control versions:
#   GroupContainer@1.4.0, Rectangle@2.3.0, Label@2.5.1, Button@0.0.45,
#   Icon@0.0.7, Gallery@2.15.0, Image@2.2.3
#
# Warning: YAML source code for Canvas Apps should only be used to review changes made
# within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  scrFuelHistory:
    Properties:
      Fill: =varTheme.Background
      LoadingSpinnerColor: =varTheme.Primary
      OnVisible: |-
        =// Reset filter to user's own transactions
        Set(varFuelHistoryFilter, "Mine");

        // Load fuel history with NULL GUARD on varUserAssociate
        ClearCollect(
            colFuelHistory,
            If(
                varUserHasProfile,
                Sort(
                    Filter(
                        'Fuel Transactions',
                        SubmittedBy.Associates = varUserAssociate.Associates
                    ),
                    TransactionDateTime,
                    SortOrder.Descending
                ),
                Blank()
            )
        );

        // Clear any lingering receipt overlay
        Set(varViewReceipt, Blank())
    Children:
      # ══════════════════════════════════════════════════════════════
      # ── HEADER (84px)
      # ══════════════════════════════════════════════════════════════
      - cmpHeader_FuelHist:
          Control: CanvasComponent
          ComponentName: cmpHeader
          Properties:
            Height: =84
            ShowBackBtn: =true
            SubTitle: =CountRows(colFuelHistory) & " transactions"
            Title: ="Fuel History"
            Width: =App.Width

      # ══════════════════════════════════════════════════════════════
      # ── BOTTOM NAVIGATION (72px)
      # ══════════════════════════════════════════════════════════════
      - cmpBottomNav_FuelHist:
          Control: CanvasComponent
          ComponentName: cmpBottomNav
          Properties:
            ActiveKey: ="Gas"
            Height: =72
            Width: =App.Width
            Y: =Parent.Height - Self.Height

      # ══════════════════════════════════════════════════════════════
      # ── FILTER BAR (52px) — My Transactions / All Transactions
      # ══════════════════════════════════════════════════════════════
      - cnrFuelFilters:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =varTheme.Surface
            Height: =52
            PaddingBottom: =0.00
            PaddingLeft: =0.00
            Width: =Parent.Width
            Y: =cmpHeader_FuelHist.Height
          Children:
            # ── Pill track background ──
            - recFilterTrack:
                Control: Rectangle@2.3.0
                Properties:
                  Fill: =varTheme.Background
                  Height: =40
                  RadiusBottomLeft: =20
                  RadiusBottomRight: =20
                  RadiusTopLeft: =20
                  RadiusTopRight: =20
                  Width: =Parent.Width - 32
                  X: =16
                  Y: =6

            # ── My Transactions pill ──
            - btnFuelFilterMine:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =If(varFuelHistoryFilter = "Mine", varTheme.Primary, Color.Transparent)
                  FontColor: =If(varFuelHistoryFilter = "Mine", varTheme.TextOnPrimary, varTheme.TextSecondary)
                  Height: =36
                  OnSelect: |-
                    =Set(varFuelHistoryFilter, "Mine");
                    // NULL GUARD: only filter by associate when profile exists
                    ClearCollect(
                        colFuelHistory,
                        If(
                            varUserHasProfile,
                            Sort(
                                Filter(
                                    'Fuel Transactions',
                                    SubmittedBy.Associates = varUserAssociate.Associates
                                ),
                                TransactionDateTime,
                                SortOrder.Descending
                            ),
                            Blank()
                        )
                    )
                  RadiusBottomLeft: =18
                  RadiusBottomRight: =18
                  RadiusTopLeft: =18
                  RadiusTopRight: =18
                  Text: ="My Transactions"
                  Width: =(Parent.Width - 40) / 2
                  X: =19
                  Y: =8

            # ── All Transactions pill ──
            - btnFuelFilterAll:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =If(varFuelHistoryFilter = "All", varTheme.Primary, Color.Transparent)
                  FontColor: =If(varFuelHistoryFilter = "All", varTheme.TextOnPrimary, varTheme.TextSecondary)
                  Height: =36
                  OnSelect: |-
                    =Set(varFuelHistoryFilter, "All");
                    ClearCollect(
                        colFuelHistory,
                        Sort(
                            'Fuel Transactions',
                            TransactionDateTime,
                            SortOrder.Descending
                        )
                    )
                  RadiusBottomLeft: =18
                  RadiusBottomRight: =18
                  RadiusTopLeft: =18
                  RadiusTopRight: =18
                  Text: ="All Transactions"
                  Width: =(Parent.Width - 40) / 2
                  X: =(Parent.Width - 40) / 2 + 21
                  Y: =8

      # ══════════════════════════════════════════════════════════════
      # ── TRANSACTION GALLERY
      # ══════════════════════════════════════════════════════════════
      - galFuelHistory:
          Control: Gallery@2.15.0
          Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
          Properties:
            BorderColor: =Color.Transparent
            FocusedBorderColor: =varTheme.Primary
            FocusedBorderThickness: =2
            Height: =Parent.Height - cmpHeader_FuelHist.Height - cnrFuelFilters.Height - cmpBottomNav_FuelHist.Height
            Items: =colFuelHistory
            LoadingSpinner: =LoadingSpinner.Controls
            TemplatePadding: =6
            TemplateSize: =104
            Visible: =CountRows(colFuelHistory) > 0
            Width: =Parent.Width
            Y: =cmpHeader_FuelHist.Height + cnrFuelFilters.Height
          Children:
            # ── Card container ──
            - cnrFuelCard:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  Height: =Parent.TemplateHeight - 8
                  PaddingBottom: =0.00
                  PaddingLeft: =0.00
                  RadiusBottomLeft: =14
                  RadiusBottomRight: =14
                  RadiusTopLeft: =14
                  RadiusTopRight: =14
                  Width: =Parent.TemplateWidth - 24
                  X: =12
                  Y: =0.00
                Children:
                  # ── Left accent bar (color by Source) ──
                  - recFuelAccent:
                      Control: Rectangle@2.3.0
                      Properties:
                        Fill: |-
                          =Switch(
                              Text(ThisItem.Source),
                              "Manual", varTheme.Primary,
                              "VoyagerFeed", varStatusColors.Available,
                              "Import", varStatusColors.Warning,
                              RGBA(96, 94, 92, 1)
                          )
                        Height: =Parent.Height - 24
                        RadiusBottomLeft: =3
                        RadiusBottomRight: =3
                        RadiusTopLeft: =3
                        RadiusTopRight: =3
                        Width: =6
                        X: =0
                        Y: =12

                  # ── Vehicle name ──
                  - lblFuelVehicle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =24
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Size: =15
                        Text: =ThisItem.Vehicle.'Vehicle Name'
                        Width: =Parent.Width - 140
                        X: =18
                        Y: =10

                  # ── Transaction date ──
                  - lblFuelDate:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =20
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Size: =12
                        Text: =Text(ThisItem.TransactionDateTime, "mmm d, yyyy")
                        Width: =Parent.Width - 140
                        X: =18
                        Y: =36

                  # ── Gallons + PPG detail (DIVIDE-BY-ZERO PROTECTION) ──
                  - lblFuelDetail:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextTertiary
                        Height: =18
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Size: =11
                        Text: |-
                          =Text(ThisItem.Gallons, "#,##0.00") & " gal  ·  $" & Text(
                              If(ThisItem.Gallons > 0, ThisItem.Amount / ThisItem.Gallons, 0),
                              "#,##0.00"
                          ) & "/gal"
                        Width: =Parent.Width - 140
                        X: =18
                        Y: =58

                  # ── Amount (right-aligned, bold) ──
                  - lblFuelAmount:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Right
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =24
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Size: =15
                        Text: ="$" & Text(ThisItem.Amount, "#,##0.00")
                        Width: =100
                        X: =Parent.Width - 116
                        Y: =10

                  # ── Source label (right-aligned) ──
                  - lblFuelSource:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Right
                        Color: =varTheme.TextSecondary
                        Height: =20
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Size: =11
                        Text: |-
                          =Switch(
                              Text(ThisItem.Source),
                              "Manual", "Manual",
                              "VoyagerFeed", "Voyager",
                              "Import", "Import",
                              Text(ThisItem.Source)
                          )
                        Width: =80
                        X: =Parent.Width - 96
                        Y: =36

                  # ── Camera / receipt icon (colored when receipt exists) ──
                  - icoFuelReceipt:
                      Control: Icon@0.0.7
                      Properties:
                        Height: =24
                        Icon: ="Camera"
                        IconColor: =If(!IsBlank(ThisItem.ReceiptImage), varTheme.Primary, varTheme.Border)
                        Width: =24
                        X: =Parent.Width - 40
                        Y: =62

                  # ── Tap handler (full card overlay — opens receipt when available) ──
                  - btnFuelTap:
                      Control: Button@0.0.45
                      Properties:
                        Appearance: ="Transparent"
                        BasePaletteColor: =Color.Transparent
                        FontColor: =Color.Transparent
                        Height: =Parent.Height
                        OnSelect: =If(!IsBlank(ThisItem.ReceiptImage), Set(varViewReceipt, ThisItem))
                        Text: =""
                        Width: =Parent.Width

      # ══════════════════════════════════════════════════════════════
      # ── EMPTY STATE
      # ══════════════════════════════════════════════════════════════
      - cnrNoFuel:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =varTheme.Surface
            Height: =200
            PaddingBottom: =0.00
            PaddingLeft: =0.00
            RadiusBottomLeft: =16
            RadiusBottomRight: =16
            RadiusTopLeft: =16
            RadiusTopRight: =16
            Visible: =CountRows(colFuelHistory) = 0
            Width: =Parent.Width - 32
            X: =16
            Y: =cmpHeader_FuelHist.Height + cnrFuelFilters.Height + 32
          Children:
            # ── Icon background circle ──
            - recNoFuelIconBg:
                Control: Rectangle@2.3.0
                Properties:
                  Fill: =varTheme.PrimaryBg
                  Height: =48
                  RadiusBottomLeft: =24
                  RadiusBottomRight: =24
                  RadiusTopLeft: =24
                  RadiusTopRight: =24
                  Width: =48
                  X: =(Parent.Width - 48) / 2
                  Y: =24

            # ── Fuel icon ──
            - icoNoFuel:
                Control: Icon@0.0.7
                Properties:
                  Height: =24
                  Icon: ="Cars"
                  IconColor: =varTheme.Primary
                  Width: =24
                  X: =(Parent.Width - 24) / 2
                  Y: =36

            # ── Empty title ──
            - lblNoFuelText:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  Color: =varTheme.TextPrimary
                  FontWeight: =FontWeight.Semibold
                  Height: =24
                  Size: =14
                  Text: ="No fuel transactions found"
                  Width: =Parent.Width
                  Y: =84

            # ── Empty description ──
            - lblNoFuelDesc:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  Color: =varTheme.TextTertiary
                  Height: =20
                  Size: =12
                  Text: ="Start tracking your fuel expenses"
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =110

            # ── CTA button ──
            - btnGoLogGas:
                Control: Button@0.0.45
                Properties:
                  Appearance: ="Transparent"
                  FontColor: =varTheme.Primary
                  FontWeight: =FontWeight.Bold
                  Height: =44
                  OnSelect: =Navigate(scrGasPurchase, ScreenTransition.Fade)
                  Text: ="Log a gas purchase"
                  Width: =200
                  X: =(Parent.Width - 200) / 2
                  Y: =140

      # ══════════════════════════════════════════════════════════════
      # ── RECEIPT OVERLAY
      # ══════════════════════════════════════════════════════════════
      - cnrReceiptOverlay:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =RGBA(0, 0, 0, 0.85)
            Height: =Parent.Height
            PaddingBottom: =0.00
            PaddingLeft: =0.00
            Visible: =!IsBlank(varViewReceipt)
            Width: =Parent.Width
          Children:
            # ── Vehicle name + date ──
            - lblReceiptTitle:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  Color: =RGBA(255, 255, 255, 1)
                  FontWeight: =FontWeight.Semibold
                  Height: =30
                  Size: =14
                  Text: |-
                    =If(
                        !IsBlank(varViewReceipt),
                        varViewReceipt.Vehicle.'Vehicle Name' & "  ·  " & Text(varViewReceipt.TransactionDateTime, "mmm d, yyyy"),
                        ""
                    )
                  Width: =Parent.Width - 32
                  X: =16
                  Y: =48

            # ── Amount (bold) ──
            - lblReceiptAmount:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  Color: =RGBA(255, 255, 255, 1)
                  FontWeight: =FontWeight.Bold
                  Height: =36
                  Size: =20
                  Text: =If(!IsBlank(varViewReceipt), "$" & Text(varViewReceipt.Amount, "#,##0.00"), "")
                  Width: =Parent.Width - 32
                  X: =16
                  Y: =78

            # ── Receipt image (properly bound to varViewReceipt.ReceiptImage) ──
            - imgReceipt:
                Control: Image@2.2.3
                Properties:
                  BorderColor: =RGBA(255, 255, 255, 0.15)
                  BorderThickness: =1
                  Height: =Parent.Height - 240
                  Image: =If(!IsBlank(varViewReceipt), varViewReceipt.ReceiptImage)
                  ImagePosition: =ImagePosition.Fit
                  RadiusBottomLeft: =12
                  RadiusBottomRight: =12
                  RadiusTopLeft: =12
                  RadiusTopRight: =12
                  Width: =Parent.Width - 48
                  X: =24
                  Y: =128

            # ── Close button ──
            - btnCloseReceipt:
                Control: Button@0.0.45
                Properties:
                  Appearance: ="Secondary"
                  BasePaletteColor: =RGBA(255, 255, 255, 1)
                  FontColor: =RGBA(255, 255, 255, 1)
                  Height: =48
                  OnSelect: =Set(varViewReceipt, Blank())
                  RadiusBottomLeft: =24
                  RadiusBottomRight: =24
                  RadiusTopLeft: =24
                  RadiusTopRight: =24
                  Text: ="Close"
                  Width: =160
                  X: =(Parent.Width - 160) / 2
                  Y: =Parent.Height - 88
