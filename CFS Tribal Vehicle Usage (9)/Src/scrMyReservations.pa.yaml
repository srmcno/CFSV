# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
#
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
#
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  scrMyReservations:
    Properties:
      Fill: =varTheme.Background
      LoadingSpinnerColor: =varTheme.Primary
      OnVisible: |-
        =ClearCollect(
            colMyReservations,
            Sort(
                Filter(
                    'Vehicle Reservations',
                    Associate.Associates = varUserAssociate.Associates
                ),
                StartDateTime,
                SortOrder.Descending
            )
        );
        Set(varResFilter, "Upcoming");
        Set(varConfirmCancelRes, Blank());
        Set(varIsSubmitting, false)
    Children:
      # ══════════════════════════════════════════════════════════════
      # HEADER (84px) – Title, subtitle with filtered count, back btn
      # ══════════════════════════════════════════════════════════════
      - cmpHeader_MyRes:
          Control: CanvasComponent
          ComponentName: cmpHeader
          Properties:
            Height: =84
            ShowBackBtn: =true
            SubTitle: |-
              =CountRows(
                  Filter(
                      colMyReservations,
                      Switch(
                          varResFilter,
                          "Upcoming", EndDateTime >= Today(),
                          "Past", EndDateTime < Today(),
                          true
                      )
                  )
              ) & " " & Lower(varResFilter) & If(varResFilter = "All", " reservations", "")
            Title: ="My Reservations"
            Width: =App.Width

      # ══════════════════════════════════════════════════════════════
      # FILTER BAR (52px) – Pill-track with Upcoming / Past / All
      # ══════════════════════════════════════════════════════════════
      - cnrResFilters:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =varTheme.Surface
            Height: =52
            PaddingBottom: =0.00
            PaddingLeft: =0.00
            Width: =Parent.Width
            Y: =cmpHeader_MyRes.Height
          Children:
            # ── Pill track background ──
            - recResFilterTrack:
                Control: Rectangle@2.3.0
                Properties:
                  Fill: =varTheme.Background
                  Height: =40
                  RadiusBottomLeft: =20
                  RadiusBottomRight: =20
                  RadiusTopLeft: =20
                  RadiusTopRight: =20
                  Width: =Parent.Width - 32
                  X: =16
                  Y: =6
            # ── Upcoming pill ──
            - btnFilterUpcoming:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =If(varResFilter = "Upcoming", varTheme.Primary, Color.Transparent)
                  FontColor: =If(varResFilter = "Upcoming", varTheme.TextOnPrimary, varTheme.TextSecondary)
                  Height: =36
                  OnSelect: =Set(varResFilter, "Upcoming")
                  RadiusBottomLeft: =18
                  RadiusBottomRight: =18
                  RadiusTopLeft: =18
                  RadiusTopRight: =18
                  Text: ="Upcoming"
                  Width: =(Parent.Width - 40) / 3
                  X: =19
                  Y: =8
            # ── Past pill ──
            - btnFilterPast:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =If(varResFilter = "Past", varTheme.Primary, Color.Transparent)
                  FontColor: =If(varResFilter = "Past", varTheme.TextOnPrimary, varTheme.TextSecondary)
                  Height: =36
                  OnSelect: =Set(varResFilter, "Past")
                  RadiusBottomLeft: =18
                  RadiusBottomRight: =18
                  RadiusTopLeft: =18
                  RadiusTopRight: =18
                  Text: ="Past"
                  Width: =(Parent.Width - 40) / 3
                  X: =(Parent.Width - 40) / 3 + 20
                  Y: =8
            # ── All pill ──
            - btnFilterAll:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =If(varResFilter = "All", varTheme.Primary, Color.Transparent)
                  FontColor: =If(varResFilter = "All", varTheme.TextOnPrimary, varTheme.TextSecondary)
                  Height: =36
                  OnSelect: =Set(varResFilter, "All")
                  RadiusBottomLeft: =18
                  RadiusBottomRight: =18
                  RadiusTopLeft: =18
                  RadiusTopRight: =18
                  Text: ="All"
                  Width: =(Parent.Width - 40) / 3
                  X: =((Parent.Width - 40) / 3) * 2 + 21
                  Y: =8

      # ══════════════════════════════════════════════════════════════
      # RESERVATION GALLERY – Cards with accent bar, info, badge, cancel
      # Visible only when the FILTERED set has rows
      # ══════════════════════════════════════════════════════════════
      - galMyReservations:
          Control: Gallery@2.15.0
          Variant: BrowseLayout_Vertical_OneTextVariant_pcfCore
          Properties:
            BorderColor: =Color.Transparent
            FocusedBorderColor: =varTheme.Primary
            FocusedBorderThickness: =2
            Height: =Parent.Height - cmpHeader_MyRes.Height - cnrResFilters.Height - cmpBottomNav_MyRes.Height
            Items: |-
              =Filter(
                  colMyReservations,
                  Switch(
                      varResFilter,
                      "Upcoming", EndDateTime >= Today(),
                      "Past", EndDateTime < Today(),
                      true
                  )
              )
            LoadingSpinner: =LoadingSpinner.Controls
            TemplatePadding: =6
            TemplateSize: =108
            Visible: |-
              =CountRows(
                  Filter(
                      colMyReservations,
                      Switch(
                          varResFilter,
                          "Upcoming", EndDateTime >= Today(),
                          "Past", EndDateTime < Today(),
                          true
                      )
                  )
              ) > 0
            Width: =Parent.Width
            Y: =cmpHeader_MyRes.Height + cnrResFilters.Height
          Children:
            - cnrResCard:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  Height: =Parent.TemplateHeight - 6
                  PaddingBottom: =0.00
                  PaddingLeft: =0.00
                  RadiusBottomLeft: =16
                  RadiusBottomRight: =16
                  RadiusTopLeft: =16
                  RadiusTopRight: =16
                  Width: =Parent.TemplateWidth - 24
                  X: =12
                  Y: =0.00
                Children:
                  # ── 6px left status accent bar ──
                  - recResAccent:
                      Control: Rectangle@2.3.0
                      Properties:
                        Fill: |-
                          =Switch(
                              ThisItem.'Status (cr63e_status)',
                              'Status (Vehicle Reservations)'.Approved, varStatusColors.Approved,
                              'Status (Vehicle Reservations)'.Submitted, varStatusColors.Submitted,
                              'Status (Vehicle Reservations)'.CheckedOut, varStatusColors.CheckedOut,
                              'Status (Vehicle Reservations)'.Returned, varStatusColors.Available,
                              'Status (Vehicle Reservations)'.Cancelled, varStatusColors.Cancelled,
                              'Status (Vehicle Reservations)'.Draft, varStatusColors.Draft,
                              RGBA(96, 94, 92, 1)
                          )
                        Height: =Parent.Height
                        RadiusBottomLeft: =16
                        RadiusTopLeft: =16
                        Width: =6
                  # ── Vehicle name (15px bold) ──
                  - lblResVehicle:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =26
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Size: =15
                        Text: =ThisItem.Vehicle.'Vehicle Name'
                        Width: =Parent.Width - 130
                        X: =20
                        Y: =10
                  # ── Date range (12px) ──
                  - lblResDates:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextSecondary
                        Height: =20
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Size: =12
                        Text: =Text(ThisItem.StartDateTime, "mmm d") & " – " & Text(ThisItem.EndDateTime, "mmm d, yyyy")
                        Width: =Parent.Width - 130
                        X: =20
                        Y: =38
                  # ── Purpose (11px, truncated single line) ──
                  - lblResPurpose:
                      Control: Label@2.5.1
                      Properties:
                        Color: =varTheme.TextTertiary
                        Height: =18
                        PaddingBottom: =0
                        PaddingLeft: =0
                        Size: =11
                        Text: =ThisItem.Purpose
                        Visible: =!IsBlank(ThisItem.Purpose)
                        Width: =Parent.Width - 130
                        X: =20
                        Y: =60
                  # ── Status badge (pill, 24px height, colored bg) ──
                  - cnrStatusBadge:
                      Control: GroupContainer@1.4.0
                      Variant: ManualLayout
                      Properties:
                        Fill: |-
                          =ColorFade(
                              Switch(
                                  ThisItem.'Status (cr63e_status)',
                                  'Status (Vehicle Reservations)'.Approved, varStatusColors.Approved,
                                  'Status (Vehicle Reservations)'.Submitted, varStatusColors.Submitted,
                                  'Status (Vehicle Reservations)'.CheckedOut, varStatusColors.CheckedOut,
                                  'Status (Vehicle Reservations)'.Returned, varStatusColors.Available,
                                  'Status (Vehicle Reservations)'.Cancelled, varStatusColors.Cancelled,
                                  'Status (Vehicle Reservations)'.Draft, varStatusColors.Draft,
                                  RGBA(96, 94, 92, 1)
                              ),
                              80%
                          )
                        Height: =24
                        PaddingBottom: =0.00
                        PaddingLeft: =0.00
                        RadiusBottomLeft: =12
                        RadiusBottomRight: =12
                        RadiusTopLeft: =12
                        RadiusTopRight: =12
                        Width: =88
                        X: =Parent.Width - 100
                        Y: =12
                      Children:
                        - lblResStatus:
                            Control: Label@2.5.1
                            Properties:
                              Align: =Align.Center
                              Color: |-
                                =Switch(
                                    ThisItem.'Status (cr63e_status)',
                                    'Status (Vehicle Reservations)'.Approved, varStatusColors.Approved,
                                    'Status (Vehicle Reservations)'.Submitted, varStatusColors.Submitted,
                                    'Status (Vehicle Reservations)'.CheckedOut, varStatusColors.CheckedOut,
                                    'Status (Vehicle Reservations)'.Returned, varStatusColors.Available,
                                    'Status (Vehicle Reservations)'.Cancelled, varStatusColors.Cancelled,
                                    'Status (Vehicle Reservations)'.Draft, varStatusColors.Draft,
                                    RGBA(96, 94, 92, 1)
                                )
                              FontWeight: =FontWeight.Semibold
                              Height: =Parent.Height
                              Size: =10
                              Text: =Upper(Text(ThisItem.'Status (cr63e_status)'))
                              Width: =Parent.Width
                  # ── Cancel button (Approved + future only) ──
                  - btnCancelRes_1:
                      Control: Button@0.0.45
                      Properties:
                        Appearance: ="Secondary"
                        BasePaletteColor: =varTheme.Danger
                        FontColor: =varTheme.Danger
                        Height: =36
                        OnSelect: =Set(varConfirmCancelRes, ThisItem)
                        Text: ="Cancel"
                        Visible: =ThisItem.EndDateTime >= Today() && ThisItem.'Status (cr63e_status)' = 'Status (Vehicle Reservations)'.Approved
                        Width: =88
                        X: =Parent.Width - 100
                        Y: =Parent.Height - 46

      # ══════════════════════════════════════════════════════════════
      # EMPTY STATE – Per-filter messaging with icon, text, CTA
      # Checks FILTERED count so each tab shows its own empty state
      # ══════════════════════════════════════════════════════════════
      - cnrNoReservations:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =varTheme.Surface
            Height: =220
            PaddingBottom: =0.00
            PaddingLeft: =0.00
            RadiusBottomLeft: =16
            RadiusBottomRight: =16
            RadiusTopLeft: =16
            RadiusTopRight: =16
            Visible: |-
              =CountRows(
                  Filter(
                      colMyReservations,
                      Switch(
                          varResFilter,
                          "Upcoming", EndDateTime >= Today(),
                          "Past", EndDateTime < Today(),
                          true
                      )
                  )
              ) = 0
            Width: =Parent.Width - 32
            X: =16
            Y: =cmpHeader_MyRes.Height + cnrResFilters.Height + 32
          Children:
            # ── Icon background circle ──
            - recNoResIconBg:
                Control: Rectangle@2.3.0
                Properties:
                  Fill: =varTheme.PrimaryBg
                  Height: =48
                  RadiusBottomLeft: =24
                  RadiusBottomRight: =24
                  RadiusTopLeft: =24
                  RadiusTopRight: =24
                  Width: =48
                  X: =(Parent.Width - 48) / 2
                  Y: =20
            # ── Calendar icon ──
            - icoNoRes:
                Control: Icon@0.0.7
                Properties:
                  Height: =24
                  Icon: ="CalendarBlank"
                  IconColor: =varTheme.Primary
                  Width: =24
                  X: =(Parent.Width - 24) / 2
                  Y: =32
            # ── Primary empty message (per-filter) ──
            - lblNoResText:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  Color: =varTheme.TextPrimary
                  FontWeight: =FontWeight.Semibold
                  Height: =24
                  Size: =14
                  Text: |-
                    =Switch(
                        varResFilter,
                        "Upcoming", "No upcoming reservations",
                        "Past", "No past reservations yet",
                        "No reservations found"
                    )
                  Width: =Parent.Width
                  Y: =80
            # ── Secondary description (per-filter) ──
            - lblNoResSubtext:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  Color: =varTheme.TextTertiary
                  Height: =22
                  Size: =12
                  Text: |-
                    =Switch(
                        varResFilter,
                        "Upcoming", "Book a vehicle to get started",
                        "Past", "Completed trips will appear here",
                        "Use the filters above or make a new reservation"
                    )
                  Width: =Parent.Width - 40
                  X: =20
                  Y: =106
            # ── CTA button (only on Upcoming & All filters) ──
            - btnMakeRes:
                Control: Button@0.0.45
                Properties:
                  Appearance: ="Transparent"
                  FontColor: =varTheme.Primary
                  FontWeight: =FontWeight.Bold
                  Height: =44
                  OnSelect: |-
                    =Set(varSelectedVehicle, Blank());
                    Set(varIsNewReservation, true);
                    Navigate(scrReservation, ScreenTransition.Fade)
                  Text: ="Make a Reservation"
                  Visible: =varResFilter <> "Past"
                  Width: =200
                  X: =(Parent.Width - 200) / 2
                  Y: =140

      # ══════════════════════════════════════════════════════════════
      # CANCEL CONFIRMATION OVERLAY – Dark backdrop + centered dialog
      # With error handling and loading state during cancellation
      # ══════════════════════════════════════════════════════════════
      - cnrConfirmCancelRes:
          Control: GroupContainer@1.4.0
          Variant: ManualLayout
          Properties:
            Fill: =RGBA(0, 0, 0, 0.5)
            Height: =Parent.Height
            PaddingBottom: =0.00
            PaddingLeft: =0.00
            Visible: =!IsBlank(varConfirmCancelRes)
            Width: =Parent.Width
          Children:
            - cnrConfirmDialog:
                Control: GroupContainer@1.4.0
                Variant: ManualLayout
                Properties:
                  Fill: =varTheme.Surface
                  Height: =230
                  PaddingBottom: =0.00
                  PaddingLeft: =0.00
                  RadiusBottomLeft: =16
                  RadiusBottomRight: =16
                  RadiusTopLeft: =16
                  RadiusTopRight: =16
                  Width: =Parent.Width - 64
                  X: =32
                  Y: =(Parent.Height - 230) / 2
                Children:
                  # ── Dialog title ──
                  - lblConfirmTitle:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =varTheme.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =32
                        Size: =16
                        Text: ="Cancel Reservation?"
                        Width: =Parent.Width
                        Y: =20
                  # ── Descriptive message ──
                  - lblConfirmMessage:
                      Control: Label@2.5.1
                      Properties:
                        Align: =Align.Center
                        Color: =varTheme.TextSecondary
                        Height: =50
                        Size: =12
                        Text: |-
                          =If(
                              !IsBlank(varConfirmCancelRes),
                              "This will cancel your reservation for " & varConfirmCancelRes.Vehicle.'Vehicle Name' & " on " & Text(varConfirmCancelRes.StartDateTime, "mmm d, yyyy") & ". This action cannot be undone.",
                              ""
                          )
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =56
                  # ── "Yes, Cancel It" danger button with error handling ──
                  - btnConfirmYes:
                      Control: Button@0.0.45
                      Properties:
                        BasePaletteColor: =varTheme.Danger
                        DisplayMode: =If(varIsSubmitting, DisplayMode.Disabled, DisplayMode.Edit)
                        FontColor: =varTheme.TextOnPrimary
                        Height: =44
                        OnSelect: |-
                          =Set(varIsSubmitting, true);
                          Set(
                              varPatchResult,
                              Patch(
                                  'Vehicle Reservations',
                                  varConfirmCancelRes,
                                  {'Status (cr63e_status)': 'Status (Vehicle Reservations)'.Cancelled}
                              )
                          );
                          If(
                              IsError(varPatchResult),
                              // Cancel failed — show error, keep dialog open
                              Set(varIsSubmitting, false);
                              Notify("Failed to cancel reservation. Please try again.", NotificationType.Error),
                              // Cancel succeeded — dismiss dialog and reload
                              Notify("Reservation cancelled", NotificationType.Success);
                              Set(varConfirmCancelRes, Blank());
                              ClearCollect(
                                  colMyReservations,
                                  Sort(
                                      Filter(
                                          'Vehicle Reservations',
                                          Associate.Associates = varUserAssociate.Associates
                                      ),
                                      StartDateTime,
                                      SortOrder.Descending
                                  )
                              );
                              Set(varIsSubmitting, false)
                          )
                        Text: =If(varIsSubmitting, "Cancelling...", "Yes, Cancel It")
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =118
                  # ── "Go Back" secondary button ──
                  - btnConfirmNo:
                      Control: Button@0.0.45
                      Properties:
                        Appearance: ="Secondary"
                        DisplayMode: =If(varIsSubmitting, DisplayMode.Disabled, DisplayMode.Edit)
                        Height: =44
                        OnSelect: =Set(varConfirmCancelRes, Blank())
                        Text: ="Go Back"
                        Width: =Parent.Width - 32
                        X: =16
                        Y: =170

      # ══════════════════════════════════════════════════════════════
      # BOTTOM NAV (72px)
      # ══════════════════════════════════════════════════════════════
      - cmpBottomNav_MyRes:
          Control: CanvasComponent
          ComponentName: cmpBottomNav
          Properties:
            ActiveKey: ="More"
            Height: =72
            Width: =App.Width
            Y: =Parent.Height - Self.Height
